<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Code Design • bbsBayes2</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="apple-touch-icon-60x60.png"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Code Design"><meta property="og:image" content="https://bbsbayes.github.io/bbsBayes2/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">bbsBayes2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="articles/bbsBayes2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbsBayes/bbsBayes2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.png" class="logo" alt=""><h1>Code Design</h1>
      <small class="dont-index">Source: <a href="https://github.com/bbsBayes/bbsBayes2/blob/v1.1.2.1/CODE_DESIGN.md" class="external-link"><code>CODE_DESIGN.md</code></a></small>
    </div>

<div id="code-design" class="section level1">

<p>This file contains notes about code design and conventions with the aim of making collaboration and future modifications easier.</p>
<div class="section level2">
<h2 id="naming">Naming<a class="anchor" aria-label="anchor" href="#naming"></a></h2>
<ul><li>Snake case is used wherever possible</li>
<li>Functions are generally named <code>verb_noun()</code> i.e. <code><a href="reference/run_model.html">run_model()</a></code> or <code><a href="reference/prepare_data.html">prepare_data()</a></code>
</li>
<li>R script files are named <code>foo-bar.R</code> whereas the main function of the file is <code>foo_bar.R</code>
</li>
</ul></div>
<div class="section level2">
<h2 id="documentation">Documentation<a class="anchor" aria-label="anchor" href="#documentation"></a></h2>
<ul><li>
<p>Descriptions for parameter arguments should follow:</p>
<ul><li><code>@param arg_name Type. Description</code></li>
<li>e.g., <code>@param min_year Numeric. Minimum year to plot</code>
</li>
<li>e.g., <code>@param add_map sf spatial object. Spatial data to add to map output</code>
</li>
<li>e.g., <code>@param quantiles Numeric vector. Quantiles to be sampled ...</code>
</li>
</ul></li>
<li><p>Document repetitive arguments (ones found in more than one function) in the <code>R/aa_common_docs.R</code> file (named to sort to the top of the folder), and use <code>@inheritParams common_docs</code> in the function documentation. This way duplicate documentation stays consistent.</p></li>
<li><p>Use <code>@noRd</code> to document internal functions (documentation for developers that isn’t compiled into the docs)</p></li>
<li>
<p>Some articles are pre-compiled to avoid super long CI building or other fragile issues</p>
<ul><li>Setup: <a href="https://ropensci.org/blog/2019/12/08/precompute-vignettes/" class="external-link uri">https://ropensci.org/blog/2019/12/08/precompute-vignettes/</a>
<ul><li>Precompiled vignettes have ext <code>.Rmd.orig</code>, then are compiled to <code>.Rmd</code> (all R code already run, so actually Vignette to HTML is super fast)</li>
<li>You also need to adjust the location of figs in the first chunk of the <code>.Rmd.orig</code> file</li>
</ul></li>
<li>In RELEASE.R there is a step for re-pre-compiling vignettes</li>
<li>For easier editing and testing, you can make RStudio treat these <code>.Rmd.orig</code> files as <code>.Rmd</code> files by clicking on the language button in the bottom right corner of the script pane and changing txt to R Markdown.</li>
</ul></li>
<li><p>Any vignette that requires the full data OR requires Stan to be installed should be put in the ‘articles’ folder (so it’s not compiled by R-Universe). These will be compiled into the pkgdown website by our GitHub actions.</p></li>
</ul></div>
<div class="section level2">
<h2 id="storing-data">Storing data<a class="anchor" aria-label="anchor" href="#storing-data"></a></h2>
<ul><li>
<code>bbs_dir()</code> figures out the folder in which to store data and creates it if needed. Use this function wherever that location is required (e.g., BBS data and model executables)</li>
<li>CRAN doesn’t like rappdirs any more</li>
<li>As of R 4.0.0 CRAN wants packages to use <code><a href="https://rdrr.io/r/tools/userdir.html" class="external-link">tools::R_user_dir()</a></code>, but this isn’t available to older versions of R.</li>
<li>Here we use the backports package to get access to this function
<ul><li>We import backports package</li>
<li>We specify which function to import (see <code>.onLoad()</code> in <code>R/bbsBayes2-package.R</code>
</li>
<li>We use <code>R_user_dir()</code> directly (no <code>pkg::</code>, see <code>bbs_dir()</code> in <code>R/fetch-bbs-data.R</code>
</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="checks">Checks<a class="anchor" aria-label="anchor" href="#checks"></a></h2>
<ul><li>Check functions are named as <code>check_XXX()</code> and stored in the R/checks.R file</li>
<li>Generally check functions should be created for any check that is
<ol style="list-style-type: lower-alpha"><li>really big (e.g., <code>check_species()</code> or <code>check_strata()</code>), or,</li>
<li>used more than once (e.g., <code>check_sf()</code>, <code>check_logical()</code>). It’s also justifiable to create check functions for ease of reading the code (e.g., the list of checks at the start of <code><a href="reference/run_model.html">run_model()</a></code>).</li>
</ol></li>
<li>
<code>deparse(substitute(name))</code> is a way of getting the original argument name submitted to this function from the parent function. That way <code>check_XXX()</code> functions can reference the correct argument name in the error messages.</li>
</ul></div>
<div class="section level2">
<h2 id="tidyeval-and-nse-non-standard-evaluation">Tidyeval and NSE (non-standard evaluation)<a class="anchor" aria-label="anchor" href="#tidyeval-and-nse-non-standard-evaluation"></a></h2>
<ul><li>In general, see <a href="https://ggplot2.tidyverse.org/reference/tidyeval.html" class="external-link uri">https://ggplot2.tidyverse.org/reference/tidyeval.html</a>, and <a href="https://ggplot2.tidyverse.org/reference/tidyeval.html" class="external-link uri">https://ggplot2.tidyverse.org/reference/tidyeval.html</a>
</li>
<li>To avoid CRAN checks, use <code>.data[["col_name"]]</code> or .data<span class="math inline">$col_name to reference
column names on the right-hand side of = inside tidyverse functions. Use
`.env$</span>var<code>to reference environmental variables. e.g.,</code>dplyr::mutate(mtcars, cyl = .data<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>p</mi><mo>*</mo><mi>.</mi><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi></mrow><annotation encoding="application/x-tex">hp * .data</annotation></semantics></math>am)<code>or</code>dplyr::mutate(mtcars, mpg = .data<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>p</mi><mi>g</mi><mi>/</mi><mi>.</mi><mi>e</mi><mi>n</mi><mi>v</mi></mrow><annotation encoding="application/x-tex">mpg / .env</annotation></semantics></math>ratio)`</li>
<li>This also allows more complex programmatic expressions, e.g., in <code><a href="reference/generate_indices.html">generate_indices()</a></code> we iterate over regions in a for loop.
<ul><li>
<code>dplyr::group_by(.data[[rr]])</code> (note the lack of quotes, as we’re calling the <em>value</em> or <code>rr</code>)</li>
<li>
<code>dplyr::mutate("{rr}" := as.character(.data[[rr]])</code> (more complex see above references)</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="sf-related">sf related<a class="anchor" aria-label="anchor" href="#sf-related"></a></h2>
<ul><li>Use <code>sf::st_agr(sf) &lt;- "constant"</code> to tell sf that the variables are spatially constant (prevents the warning “attribute variables are assumed to be spatially constant throughout all geometries”).</li>
</ul></div>
<div class="section level2">
<h2 id="example-data">Example data<a class="anchor" aria-label="anchor" href="#example-data"></a></h2>
<ul><li>If possible, all examples and required data are created by <code>data-raw/data_XXX.R</code>
</li>
<li>Currently, all data are exported, so usable by the user as well as functions.</li>
<li>For (stupid) reasons, exported data (e.g., <code>species_forms</code>) need to be referenced via <code><a href="https://rdrr.io/r/utils/data.html" class="external-link">bbsBayes2::data</a></code> (e.g., <code><a href="reference/species_forms.html">bbsBayes2::species_forms</a></code>) <em>inside</em> bbsBayes2 functions (See here for more details/other options: <a href="https://coolbutuseless.github.io/2018/12/10/r-packages-internal-and-external-data/" class="external-link uri">https://coolbutuseless.github.io/2018/12/10/r-packages-internal-and-external-data/</a>)</li>
</ul></div>
<div class="section level2">
<h2 id="testing-and-examples">Testing and examples<a class="anchor" aria-label="anchor" href="#testing-and-examples"></a></h2>
<ul><li>When in doubt <code>skip_on_cran()</code> for tests (never run fragile tests that <em>might</em> fail)</li>
<li>Use <code>@examplesIf interactive()</code> to skip examples that can be run but shouldn’t be tested (e.g., <code><a href="reference/fetch_bbs_data.html">fetch_bbs_data()</a></code>)</li>
<li>Use <code>@examplesIf have_bbs_data()</code> to skip examples that require a full download of BBS data. This is for R-Universe builds, our GitHub Actions fetch the data first.</li>
<li>Use <code>@examplesIf have_cmdstan()</code> to skip examples that require Stan to be installed (i.e. anything that will use <code><a href="reference/run_model.html">run_model()</a></code>). This is for R-Universe builds, our GitHub Actions install Stan first.</li>
<li>use <code>\dontest</code> for examples that should <em>never</em> be run (try not to have too many)</li>
<li>use <code>\dontrun</code> for examples that won’t fail, but will take a while to run.</li>
<li>use first_diff model output by <code>test-XX_run_model.R</code> to ensure an up-to-date model example for testing <code>test-XX_generate_indices.R</code>, <code>test-XX_generate_trends.R</code> and <code>test-XX_plots.R</code>
</li>
<li>use <code>pacific_wren_slope_model</code> example model for tests needing to check for alternate n. Don’t create it in <code>test-XX_run_model.R</code> because it takes too long.</li>
<li>When tracking down lifecycle warnings from tidyverse packages, it can be helpful to set <code>options(lifecycle_verbosity = "error")</code> so that the warnings become hard errors which fail every time (you should be able to do “warning” but I found this didn’t work for me).</li>
</ul></div>
<div class="section level2">
<h2 id="continuous-integration-ci">Continuous Integration (CI)<a class="anchor" aria-label="anchor" href="#continuous-integration-ci"></a></h2>
<ul><li>CI is setup with GitHub actions. The workflows (all in <code>.github/workflows/</code> were created using:
<ul><li>Package Checks - <code>usethis::use_github_action_check_standard()</code> (file is <code>R-CMD-check.yaml</code>)</li>
<li>Code Coverage - <code>usethis::use_coverage()</code> (file is <code>test-coverage.yaml</code>)</li>
<li>Documentation website - <code>usethis::use_pkgdown_github_pages()</code> (file is <code>pkgdown.yaml</code>)</li>
</ul></li>
<li>Note that Package Checks don’t build vignettes because a) this the download in the <code>stratification.Rmd</code> vignette fails on Windows, and b) these are already built (and therefore tested) in the pkgdown workflow.</li>
</ul></div>
<div class="section level2">
<h2 id="random-notes">Random Notes<a class="anchor" aria-label="anchor" href="#random-notes"></a></h2>
<ul><li>Use “grey60” rather than <code>grDevices::grey(0.6)</code> to avoid another dependency</li>
</ul></div>
<div class="section level2">
<h2 id="deprecating-defunct-ing-and-other-big-changes">Deprecating, Defunct-ing, and other big changes<a class="anchor" aria-label="anchor" href="#deprecating-defunct-ing-and-other-big-changes"></a></h2>
<ul><li>See <code>R/bbsBayes2-defunct.R</code> for listing all defunct packages in a document page</li>
<li>See <code>R/bbsBayes2-deprectated.R</code> for listing all deprecated packages in a document page</li>
<li>
<code>dep_stop()</code> and <code>dep_warn()</code> are created in <code>bbsBayes2-defunct.R</code> and can be used to stop or warn on use of functions or arguments, depending.</li>
<li>To deprecate a function
<ul><li>Add <code>dep_warn()</code> to the start of the function call and either continue, or switch to new function (e.g., <code>R/bbsBayes2-deprectated.R</code>)</li>
<li>Add to documentation for <code>bbsBayes2-deprecated</code>
</li>
</ul></li>
<li>To make a function defunct
<ul><li>Add <code>dep_stop()</code> to the start of the function call and remove the rest of the code (for clarity) (e.g., <code>R/bbsBayes2-defunct.R</code>)</li>
<li>Add to documentation for <code>bbsBayes2-defunct</code>
</li>
</ul></li>
<li>To deprecate/defunct an argument
<ul><li>Move the argument in the <code>function()</code> call to the end of the list, without a default</li>
<li>Move the documentation for that argument to the end of the list and mark “Deprecated. Use X instead”, or just “Deprecated.” (or Defunct)</li>
<li>If deprecated with a replacement, add <code>if(!missing(arg)) {dep_warn(...)}</code> to the start of the function and use arg_new &lt;- arg_old inside the condition</li>
<li>If defunct or without a replacement, add <code>if(!missing(arg)) dep_warn(...)</code> or <code>if(!missing(arg)) dep_stop(...)</code>
</li>
</ul></li>
</ul></div>
<div class="section level2">
<h2 id="useful-tips">Useful tips<a class="anchor" aria-label="anchor" href="#useful-tips"></a></h2>
<ul><li>Use Ctrl-Shift-L to load all package functions via <code>devtools::load_all()</code> see <a href="https://r-pkgs.org/workflow101.html#sec-load-all" class="external-link uri">https://r-pkgs.org/workflow101.html#sec-load-all</a>
</li>
<li>Use Ctrl-Shift / to automatically text-wrap</li>
<li>Use Ctrl Click on any function to jump to that function’s definition</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brandon P.M. Edwards, Adam C. Smith, Steffi LaZerte.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

