<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="bbsBayes2">
<title>Advanced Example • bbsBayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Example">
<meta property="og:description" content="bbsBayes2">
<meta property="og:image" content="https://bbsbayes.github.io/bbsBayes2/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">bbsBayes2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9999</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/bbsBayes2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bbsBayes/bbsBayes2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bbsBayes/bbsBayes2/blob/HEAD/vignettes/articles/advanced.Rmd" class="external-link"><code>vignettes/articles/advanced.Rmd</code></a></small>
      <div class="d-none name"><code>advanced.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbsBayes/bbsBayes2" class="external-link">bbsBayes2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="basic-status-and-trend-analyses">Basic Status and Trend Analyses<a class="anchor" aria-label="anchor" href="#basic-status-and-trend-analyses"></a>
</h2>
<p>bbsBayes2 provides functions for every stage of Breeding Bird Survey
data analysis.</p>
<div class="section level3">
<h3 id="data-retrieval">Data Retrieval<a class="anchor" aria-label="anchor" href="#data-retrieval"></a>
</h3>
<p>You can download BBS data by running <code>fetch_bbs_data</code>.
This will save it to a package-specific directory on your computer. You
must agree to the terms and conditions of the data usage before
downloading. You only need run this function once for each annual update
of the BBS database.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fetch_bbs_data.html">fetch_bbs_data</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="data-preparation">Data Preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<div class="section level4">
<h4 id="stratification">Stratification<a class="anchor" aria-label="anchor" href="#stratification"></a>
</h4>
<p>Stratification plays an important role in trend analysis. Use the
<code><a href="../reference/stratify.html">stratify()</a></code> function for this job. Set the argument
<code>by</code> to stratify by the following options:</p>
<ul>
<li>
<code>bbs_cws</code> – Political region X Bird Conservation region
intersection (Canadian Wildlife Service [CWS] method)</li>
<li>
<code>bbs_usgs</code> – Political region X Bird Conservation region
intersection (United Status Geological Survey [USGS] method)</li>
<li>
<code>bcr</code> – Bird Conservation Region only</li>
<li>
<code>state</code> – Political Region only</li>
<li>
<code>latlong</code> – Degree blocks (1 degree of latitude X 1
degree of longitude)</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_cws"</span>, species <span class="op">=</span> <span class="st">"Barn Swallow"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="stan-data">Stan Data<a class="anchor" aria-label="anchor" href="#stan-data"></a>
</h4>
<p>Stan models require the data to be sent as a list depending on how
the model is set up. <code><a href="../reference/prepare_data.html">prepare_data()</a></code> subsets the stratified
data based on species and wrangles relevant data to use for Stan
models.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">s</span>, min_max_route_years <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="model-data">Model Data<a class="anchor" aria-label="anchor" href="#model-data"></a>
</h4>
<p>To prepare to run the model, initialization parameters and other
model parameters need to be calculated based on the model and model
variant chosen. These are calculated in a separate step to provide more
information for troubleshooting as well as to allow more advanced
customizations of these parameters.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">p</span>, model <span class="op">=</span> <span class="st">"gamye"</span>, heavy_tailed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="mcmc">MCMC<a class="anchor" aria-label="anchor" href="#mcmc"></a>
</h3>
<p>Once the data has been prepared for Stan, the model can be run. The
following will run MCMC with default number of iterations. Note that
this step usually takes a long time (e.g., 6-12 hours, or even days
depending on the species, model).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">md</span>, output_basename <span class="op">=</span> <span class="st">"cws_basw_gamye"</span>,</span>
<span>                 iter_sampling <span class="op">=</span> <span class="fl">10</span>, iter_warmup <span class="op">=</span> <span class="fl">10</span>, chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, you can set how many iterations for sampling or warm
up steps, how many chains, and how many to run in parallel.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">md</span>, output_basename <span class="op">=</span> <span class="st">"cws_basw_gamye"</span>,</span>
<span>                 iter_sampling <span class="op">=</span> <span class="fl">2000</span>, iter_warmup <span class="op">=</span> <span class="fl">500</span>, </span>
<span>                 chains <span class="op">=</span> <span class="fl">4</span>, parallel_chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/run_model.html">run_model()</a></code> function generates a large object that
includes the posterior draws, convergence information, data, etc. By
default, this a copy of this object is saved as an RDS file to your
model directory (working directory unless <code>output_dir</code> is
specified.</p>
<p>You can load this in with</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"cws_basw_gamye.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="convergence">Convergence<a class="anchor" aria-label="anchor" href="#convergence"></a>
</h3>
<p>The <code><a href="../reference/run_model.html">run_model()</a></code> function will send a warning if
Gelman-Rubin Rhat cross-chain convergence criterion is &gt; 1.1 for any
of the monitored parameters. Re-running the model with a longer burn-in
and/or more posterior iterations or greater thinning rates may improve
convergence. The seriousness of these convergence failures is something
the user must interpret for themselves. In some cases some parameters of
the model may not be separately estimable, but if there is no direct
inference drawn from those separate parameters, their convergence may
not be necessary. If all or the vast majority of the n parameters have
converged (e.g., you’re receiving this warning message for other
monitored parameters), then inference on population trajectories and
trends from the model are reliable.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jags_mod</span><span class="op">$</span><span class="va">n.eff</span> <span class="co">#shows the effective sample size for each monitored parameter</span></span>
<span><span class="va">jags_mod</span><span class="op">$</span><span class="va">Rhat</span> <span class="co"># shows the Rhat values for each monitored parameter</span></span></code></pre></div>
<p>If important monitored parameters have not converged, we recommend
inspecting the model diagnostics with the package ggmcmc.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggmcmc"</span><span class="op">)</span></span>
<span><span class="va">S</span> <span class="op">&lt;-</span> <span class="fu">ggmcmc</span><span class="fu">::</span><span class="fu">ggs</span><span class="op">(</span><span class="va">jags_mod</span><span class="op">$</span><span class="va">samples</span>,family <span class="op">=</span> <span class="st">"B.X"</span><span class="op">)</span> <span class="co">#samples object is an mcmc.list object</span></span>
<span><span class="fu">ggmcmc</span><span class="fu">::</span><span class="fu">ggmcmc</span><span class="op">(</span><span class="va">S</span>,family <span class="op">=</span> <span class="st">"B.X"</span><span class="op">)</span> <span class="co">## this will output a pdf with a series of plots useful for assessing convergence. Be warned this function will be overwhelmed if trying to handle all of the n values from a BBS analysis of a broad-ranged species</span></span></code></pre></div>
<p>bbsBayes2 also includes a function to help re-start an MCMC chain, so
that you avoid having to wait for an additional burn-in period.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### if jags_mod has failed to converge...</span></span>
<span><span class="va">new_initials</span> <span class="op">&lt;-</span> <span class="fu">get_final_values</span><span class="op">(</span><span class="va">jags_mod</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jags_mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span>jags_data <span class="op">=</span> <span class="va">jags_data</span>,</span>
<span>                               n_saved_steps <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                               n_burnin <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                               n_chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                               n_thin <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                               parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                               inits <span class="op">=</span> <span class="va">new_initials</span>,</span>
<span>                          parameters_to_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"n3"</span>, <span class="st">"nu"</span>, <span class="st">"B.X"</span>, <span class="st">"beta.X"</span>, <span class="st">"strata"</span>, <span class="st">"sdbeta"</span>, <span class="st">"sdX"</span><span class="op">)</span>,</span>
<span>                          modules <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="model-predictions">Model Predictions<a class="anchor" aria-label="anchor" href="#model-predictions"></a>
</h2>
<p>There are a number of tools available to summarize and visualize the
posterior predictions from the model.</p>
<div class="section level3">
<h3 id="annual-indices-of-abundance-and-population-trajectories">Annual Indices of Abundance and Population Trajectories<a class="anchor" aria-label="anchor" href="#annual-indices-of-abundance-and-population-trajectories"></a>
</h3>
<p>The main monitored parameters are the annual indices of relative
abundance within a stratum (i.e., parameters
<code>n[strata,year]</code>). The time-series of these annual indices
form the estimated population trajectories.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<p>By default, this function generates estimates for the continent
(i.e., survey-wide) and for the individual strata. However, the user can
also select summaries for composite regions (regions made up of
collections of strata), such as countries, provinces/states, Bird
Conservation Regions, etc. For display, the posterior medians are used
for annual indices (instead of the posterior means) due to the
asymetrical distributions caused by the log-linear retransformation.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>                            regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"continental"</span>,</span>
<span>                                        <span class="st">"national"</span>,</span>
<span>                                        <span class="st">"prov_state"</span>,</span>
<span>                                        <span class="st">"stratum"</span><span class="op">)</span><span class="op">)</span></span>
<span>                           <span class="co"># also "bcr", "bcr_by_country"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="population-trends">Population Trends<a class="anchor" aria-label="anchor" href="#population-trends"></a>
</h3>
<p>Population trends can be calculated from the series of annual indices
of abundance. The trends are expressed as geometric mean rates of change
(%/year) between two points in time. <span class="math inline">\(Trend =
(\frac {n[minyear]}{n[maxyear]})^{(1/(maxyear-minyear))}\)</span></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">indices</span>,  </span>
<span>                          min_year <span class="op">=</span> <span class="fl">1970</span>,</span>
<span>                          max_year <span class="op">=</span> <span class="fl">2018</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/generate_trends.html">generate_trends()</a></code> function returns a dataframe with
1 row for each unit of the region-types requested in the
<code><a href="../reference/generate_indices.html">generate_indices()</a></code> function (i.e., 1 for each stratum, 1
continental, etc.). The dataframe has at least 27 columns that report
useful information related to each trend, including the start and end
year of the trend, lists of included strata, total number of routes,
number of strata, mean observed counts, and estimates of the % change in
the population between the start and end years.</p>
<p>The <code><a href="../reference/generate_trends.html">generate_trends()</a></code> function includes some other
arguments that allow the user to adjust the quantiles used to summarize
uncertainty (e.g., interquartile range of the trend estiamtes, or the
67% CIs), as well as include additional calculations, such as the
probability a population has declined (or increased) by &gt; X%.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">indices</span>,</span>
<span>                          min_year <span class="op">=</span> <span class="fl">1970</span>,</span>
<span>                          max_year <span class="op">=</span> <span class="fl">2018</span>,</span>
<span>                          prob_decrease <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>                          prob_increase <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">33</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="visualizing-predictions">Visualizing Predictions<a class="anchor" aria-label="anchor" href="#visualizing-predictions"></a>
</h2>
<div class="section level3">
<h3 id="population-trajectories">Population Trajectories<a class="anchor" aria-label="anchor" href="#population-trajectories"></a>
</h3>
<p>Generate plots of the population trajectories through time. The
<code><a href="../reference/plot_indices.html">plot_indices()</a></code> function produces a list of ggplot figures
that can be combined into a single pdf file, or printed to individual
devices.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">indices</span>,</span>
<span>                   add_observed_means <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># pdf(file = "Barn Swallow Trajectories.pdf")</span></span>
<span><span class="co"># print(tp)</span></span>
<span><span class="co"># dev.off()</span></span>
<span><span class="va">tp</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="reference/figures/BARS_Continental_Trajectory.png"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tp</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="reference/figures/BARS_Canada_Trajectory.png"> etc.</p>
</div>
<div class="section level3">
<h3 id="trend-maps">Trend Maps<a class="anchor" aria-label="anchor" href="#trend-maps"></a>
</h3>
<p>The trends can be mapped to produce strata maps coloured by species
population trends.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">trends</span>, col_viridis <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">mp</span></span></code></pre></div>
<p><img src="reference/figures/BARS_trendmap.png"></p>
</div>
<div class="section level3">
<h3 id="geofacet-trajectories">Geofacet Trajectories<a class="anchor" aria-label="anchor" href="#geofacet-trajectories"></a>
</h3>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_geofacet.html">plot_geofacet</a></span><span class="op">(</span>indices_list <span class="op">=</span> <span class="va">indices</span>,</span>
<span>                    trends <span class="op">=</span> <span class="va">trends</span>,</span>
<span>                    multiple <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    slope <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#png("BARS_geofacet.png",width = 1500, height = 750,res = 150)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gf</span><span class="op">)</span></span>
<span><span class="co">#dev.off()</span></span></code></pre></div>
<p><img src="reference/figures/BARS_geofacet.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="example---replicating-the-cws-status-and-trend-estimates-2018-version-onwards">EXAMPLE - Replicating the CWS status and trend estimates (2018
version onwards)<a class="anchor" aria-label="anchor" href="#example---replicating-the-cws-status-and-trend-estimates-2018-version-onwards"></a>
</h2>
<p>The CWS analysis, as of the 2018 BBS data-version, uses the GAMYE
model. It also monitors two estimates of the population trajectory: *
one for visualizing the trajectory that includes the annual fluctuations
estimated by the year-effects “n” * and another for calculation trends
using a trajectory that removes the annual fluctuations around the
smooth “n3”.</p>
<p>The full script to run the CWS analysis for the 2018 BBS data version
is accessible here: <a href="https://github.com/AdamCSmithCWS/BBS_Summaries" class="external-link uri">https://github.com/AdamCSmithCWS/BBS_Summaries</a></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species.eng</span> <span class="op">=</span> <span class="st">"Pacific Wren"</span></span>
<span></span>
<span><span class="va">stratified_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_cws"</span><span class="op">)</span> <span class="co">#same as USGS but with BCR7 as one stratum and PEI and Nova Scotia combined into one stratum</span></span>
<span></span>
<span><span class="va">jags_data</span> <span class="op">&lt;-</span> <span class="fu">prepare_jags_data</span><span class="op">(</span>strat_data <span class="op">=</span> <span class="va">stratified_data</span>,</span>
<span>                                 species_to_run <span class="op">=</span> <span class="va">species.eng</span>,</span>
<span>                                 min_max_route_years <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                                 model <span class="op">=</span> <span class="st">"gamye"</span>, </span>
<span>                                 heavy_tailed <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="co">#heavy-tailed version of gamye model</span></span>
<span>                                 </span>
<span>                                 </span>
<span><span class="va">jags_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span>jags_data <span class="op">=</span> <span class="va">jags_data</span>,</span>
<span>                               n_saved_steps <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                               n_burnin <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                               n_chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                               n_thin <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                               parallel <span class="op">=</span> <span class="cn">F</span>, </span>
<span>                          parameters_to_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n"</span>,<span class="st">"n3"</span>,<span class="st">"nu"</span>,<span class="st">"B.X"</span>,<span class="st">"beta.X"</span>,<span class="st">"strata"</span>,<span class="st">"sdbeta"</span>,<span class="st">"sdX"</span><span class="op">)</span>,</span>
<span>                          modules <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># n and n3 allow for index and trend calculations, other parameters monitored to help assess convergence and for model testing </span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example---replicating-approximately-the-earlier-usgs-status-and-trend-estimates-2011---2017-data-versions">EXAMPLE - Replicating (approximately) the earlier USGS status and
trend estimates (2011 - 2017 data versions)<a class="anchor" aria-label="anchor" href="#example---replicating-approximately-the-earlier-usgs-status-and-trend-estimates-2011---2017-data-versions"></a>
</h2>
<p>The USGS analysis, from 2011 through 2017, uses the SLOPE model.
Future analyses from the USGS will likely use the first difference model
(see, Link et al. 2017 <a href="https://doi.org/10.1650/CONDOR-17-1.1" class="external-link uri">https://doi.org/10.1650/CONDOR-17-1.1</a>)</p>
<p>NOTE: the USGS analysis is not run using the bbsBayes2 package, and
so this analysis may not exactly replicate the published version.
However, any variations should be very minor.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species.eng</span> <span class="op">=</span> <span class="st">"Pacific Wren"</span></span>
<span></span>
<span><span class="va">stratified_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_usgs"</span><span class="op">)</span> <span class="co">#BCR by province/state/territory intersections</span></span>
<span></span>
<span><span class="va">jags_data</span> <span class="op">&lt;-</span> <span class="fu">prepare_jags_data</span><span class="op">(</span>strat_data <span class="op">=</span> <span class="va">stratified_data</span>,</span>
<span>                                 species_to_run <span class="op">=</span> <span class="va">species.eng</span>,</span>
<span>                                 min_max_route_years <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                 model <span class="op">=</span> <span class="st">"slope"</span>, </span>
<span>                                 heavy_tailed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co">#normal-tailed version of slope model</span></span>
<span>                                 </span>
<span>                                 </span>
<span><span class="va">jags_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span>jags_data <span class="op">=</span> <span class="va">jags_data</span>,</span>
<span>                               n_saved_steps <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>                               n_burnin <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>                               n_chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                               n_thin <span class="op">=</span> <span class="fl">20</span>,</span>
<span>                               parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                               track_n <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                               parameters_to_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n2"</span><span class="op">)</span>, <span class="co">#more on this alternative annual index below</span></span>
<span>                          modules <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="advanced-options-and-customized-models">Advanced options and customized models<a class="anchor" aria-label="anchor" href="#advanced-options-and-customized-models"></a>
</h2>
</div>
<div class="section level2">
<h2 id="alternative-models">Alternative Models<a class="anchor" aria-label="anchor" href="#alternative-models"></a>
</h2>
<p>The package has (currently) four status and trend models that differ
somewhat in the way they model the time-series of observations. The four
model options are slope, gam, gamye, and firstdiff.
<img src="reference/figures/AMKE_all.png"></p>
<div class="section level3">
<h3 id="slope">slope<a class="anchor" aria-label="anchor" href="#slope"></a>
</h3>
<p>The slope option estimates the time series as a log-linear regression
with random year-effect terms that allow the trajectory to depart from
the smooth regression line. It is the model used by the USGS and CWS to
estimate bbs trends since 2011. The basic model was first described in
2002 (Link and Sauer 2002; <a href="https://doi.org/10.1890/0012-9658(2002)083%5B2832:AHAOPC%5D2.0.CO;2" class="external-link uri">https://doi.org/10.1890/0012-9658(2002)083[2832:AHAOPC]2.0.CO;2</a>)
and its application to the annual status and trend estimates is
documented in Sauer and Link (2011; <a href="https://doi.org/10.1525/auk.2010.09220" class="external-link uri">https://doi.org/10.1525/auk.2010.09220</a>) and Smith et
al. (2014; <a href="https://doi.org/10.22621/cfn.v128i2.1565" class="external-link uri">https://doi.org/10.22621/cfn.v128i2.1565</a>).</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="co">#stratified_data &lt;- stratify(by = "bbs_usgs")</span></span>
<span>    </span>
<span>    <span class="co">#jags_data_slope &lt;- prepare_jags_data(stratified_data, </span></span>
<span>    <span class="co">#                           species_to_run = "American Kestrel",</span></span>
<span>    <span class="co">#                           min_max_route_years = 3,</span></span>
<span>    <span class="co">#                           model = "slope")</span></span>
<span></span>
<span>    <span class="co">#jags_mod_full_slope &lt;- run_model(jags_data = jags_data)</span></span>
<span>                               </span>
<span>    <span class="va">slope_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span>jags_mod <span class="op">=</span> <span class="va">jags_mod_full_slope</span>,</span>
<span>                                  jags_data <span class="op">=</span> <span class="va">jags_data_slope</span>,</span>
<span>                                  regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"continental"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">slope_plot</span> <span class="op">=</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">slope_ind</span>,</span>
<span>                         species <span class="op">=</span> <span class="st">"American Kestrel SLOPE"</span>,</span>
<span>                         add_observed_means <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="co">#png("AMKE_Slope.png", width = 1500,height = 900,res = 150)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">slope_plot</span><span class="op">)</span></span>
<span>    <span class="co">#dev.off()</span></span>
<span>    </span></code></pre></div>
<p><img src="reference/figures/AMKE_slope.png"></p>
</div>
<div class="section level3">
<h3 id="gam">gam<a class="anchor" aria-label="anchor" href="#gam"></a>
</h3>
<p>The gam option models the time series as a semiparametric smooth
using a Generalized Additive Model (GAM) structure. See <a href="https://github.com/AdamCSmithCWS/Smith_Edwards_GAM_BBS" class="external-link uri">https://github.com/AdamCSmithCWS/Smith_Edwards_GAM_BBS</a>
for more information (full publication coming soon)</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="co">#stratified_data &lt;- stratify(by = "bbs_usgs")</span></span>
<span>    </span>
<span>    <span class="co">#jags_data_gam &lt;- prepare_jags_data(stratified_data, </span></span>
<span>    <span class="co">#                           species_to_run = "American Kestrel",</span></span>
<span>    <span class="co">#                           min_max_route_years = 3,</span></span>
<span>    <span class="co">#                           model = "gam")</span></span>
<span></span>
<span>    <span class="co">#jags_mod_full_gam &lt;- run_model(jags_data = jags_data)</span></span>
<span>                               </span>
<span>    <span class="va">gam_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span>jags_mod <span class="op">=</span> <span class="va">jags_mod_full_gam</span>,</span>
<span>                                jags_data <span class="op">=</span> <span class="va">jags_data_gam</span>,</span>
<span>                                regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"continental"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">gam_plot</span> <span class="op">=</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">gam_ind</span>,</span>
<span>                         species <span class="op">=</span> <span class="st">"American Kestrel GAM"</span>,</span>
<span>                         add_observed_means <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="co">#png("AMKE_gam.png", width = 1500,height = 900,res = 150)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gam_plot</span><span class="op">)</span></span>
<span>    <span class="co">#dev.off()</span></span>
<span>    </span></code></pre></div>
<p><img src="reference/figures/AMKE_gam.png"></p>
</div>
<div class="section level3">
<h3 id="gamye">gamye<a class="anchor" aria-label="anchor" href="#gamye"></a>
</h3>
<p>The gamye option includes the semiparametric smooth used in the gam
option, but also includes random year-effect terms that track annual
fluctuations around the smooth. This is the model that the Canadian
Wildlife Service is now using for the annual status and trend
estimates.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="co">#stratified_data &lt;- stratify(by = "bbs_usgs")</span></span>
<span>    </span>
<span>    <span class="co">#jags_data_gamye &lt;- prepare_jags_data(stratified_data, </span></span>
<span>    <span class="co">#                           species_to_run = "American Kestrel",</span></span>
<span>    <span class="co">#                           min_max_route_years = 3,</span></span>
<span>    <span class="co">#                           model = "gamye")</span></span>
<span></span>
<span>    <span class="co">#jags_mod_full_gamye &lt;- run_model(jags_data = jags_data)</span></span>
<span>                               </span>
<span>    <span class="va">gamye_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span>jags_mod <span class="op">=</span> <span class="va">jags_mod_full_gamye</span>,</span>
<span>                                  jags_data <span class="op">=</span> <span class="va">jags_data_gamye</span>,</span>
<span>                                  regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"continental"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">gamye_plot</span> <span class="op">=</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">gamye_ind</span>,</span>
<span>                         species <span class="op">=</span> <span class="st">"American Kestrel GAMYE"</span>,</span>
<span>                         add_observed_means <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="co">#png("AMKE_gamye.png", width = 1500,height = 900,res = 150)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gamye_plot</span><span class="op">)</span></span>
<span>    <span class="co">#dev.off()</span></span>
<span>    </span></code></pre></div>
<p><img src="reference/figures/AMKE_gamye.png"></p>
</div>
<div class="section level3">
<h3 id="firstdiff">firstdiff<a class="anchor" aria-label="anchor" href="#firstdiff"></a>
</h3>
<p>The firstdiff option models the time-series as a random-walk from the
first year, so that the first-differences of the sequence of
year-effects are random effects with mean = 0 and an estimated variance.
This model has been described in Link et al. 2017 <a href="https://doi.org/10.1650/CONDOR-17-1.1" class="external-link uri">https://doi.org/10.1650/CONDOR-17-1.1</a></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="co">#stratified_data &lt;- stratify(by = "bbs_usgs")</span></span>
<span>    </span>
<span>    <span class="co">#jags_data_firstdiff &lt;- prepare_jags_data(stratified_data, </span></span>
<span>    <span class="co">#                           species_to_run = "American Kestrel",</span></span>
<span>    <span class="co">#                           min_max_route_years = 3,</span></span>
<span>    <span class="co">#                           model = "firstdiff")</span></span>
<span></span>
<span>    <span class="co">#jags_mod_full_firstdiff &lt;- run_model(jags_data = jags_data)</span></span>
<span>                               </span>
<span>    <span class="va">firstdiff_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span>jags_mod <span class="op">=</span> <span class="va">jags_mod_full_firstdiff</span>,</span>
<span>                                      jags_data <span class="op">=</span> <span class="va">jags_data_firstdiff</span>,</span>
<span>                                      regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"continental"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">firstdiff_plot</span> <span class="op">=</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">firstdiff_ind</span>,</span>
<span>                         species <span class="op">=</span> <span class="st">"American Kestrel FIRSTDIFF"</span>,</span>
<span>                         add_observed_means <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="co">#png("AMKE_firstdiff.png", width = 1500,height = 900,res = 150)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">firstdiff_plot</span><span class="op">)</span></span>
<span>    <span class="co">#dev.off()</span></span>
<span>    </span></code></pre></div>
<p><img src="reference/figures/AMKE_firstdiff.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="alternate-extra-poisson-error-distributions">Alternate extra-Poisson error distributions<a class="anchor" aria-label="anchor" href="#alternate-extra-poisson-error-distributions"></a>
</h2>
<p>For all of the models, the BBS counts on a given route and year are
modeled as Poisson variables with over-dispersion. The over-dispersion
approach used here is to add a count-level random effect that adds extra
variance to the unit variance:mean ratio of the Poisson. In the
<code>prepare_jags_data</code> function, the user can choose between two
distributions to model the extra-Poisson variance:</p>
<ul>
<li>the default normal distribution
(<code>heavy_tailed = FALSE</code>)</li>
<li>an alternative heavy-tailed t-distribution.
(<code>heavy_tailed = TRUE</code>)</li>
</ul>
<p>The heavy-tailed version is well supported for many species,
particularly species that are sometimes observed in large groups. Note:
the heavy-tailed version can require significantly more time to converge
(~2-5 fold increase in processing time).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#stratified_data &lt;- stratify(by = "bbs_usgs")</span></span>
<span>    </span>
<span>    <span class="co">#jags_data_firstdiff &lt;- prepare_jags_data(stratified_data, </span></span>
<span>    <span class="co">#                           species_to_run = "American Kestrel",</span></span>
<span>    <span class="co">#                           min_max_route_years = 3,</span></span>
<span>    <span class="co">#                           model = "firstdiff",</span></span>
<span>    <span class="co">#                           heavy_tailed = TRUE) </span></span>
<span></span>
<span>    <span class="co">#jags_mod_full_firstdiff &lt;- run_model(jags_data = jags_data)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="alternate-annual-indices-and-resulting-trends">Alternate Annual Indices and Resulting Trends<a class="anchor" aria-label="anchor" href="#alternate-annual-indices-and-resulting-trends"></a>
</h2>
<p>In all the models, the default measure of the annual index of
abundance (the yearly component of the population trajectory) is the
derived parameter “n”. The <code>run_model</code> function monitors n by
default, because it is these parameters that form the basis of the
estimated population trajectories and trends.</p>
<div class="section level3">
<h3 id="alternate-retransformations">Alternate retransformations<a class="anchor" aria-label="anchor" href="#alternate-retransformations"></a>
</h3>
<p>There are two ways of calculating these annual indices for each
model. The two approaches differ in the way they calculate the
retransformation from the log-scale model parameters to the count-scale
predictions. The user can choose using the following arguments in
<code><a href="../reference/run_model.html">run_model()</a></code> and <code><a href="../reference/generate_indices.html">generate_indices()</a></code>.</p>
<ul>
<li>the default, estimates the mean of the expected counts from the
existing combinations of observers and routes in a given stratum and
year. This approach retransforms an annual prediction for every
observer-route combination in the stratum and then averages across those
predictions.</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                 parameters_to_save <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>                 <span class="va">...</span> <span class="op">)</span></span>
<span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                            alternate_n <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>                            <span class="va">...</span> <span class="op">)</span></span></code></pre></div>
<ul>
<li>the alternative,
<code>parameters_to_save = c("n2"), track_n = FALSE</code> is actually
the standard approach used in the USGS status and trend estimates. It
estimates the the expected count from a new observer-route combination,
assuming the distribution of observer-route effects is approximately
normal. This approach uses a log-normal retransformation factor that
adds half of the estimated variance of observer-route effects to the
log-scale prediction for each year and stratum, then retransforms that
log-scale prediction to the count-scale. This is the approach described
in Sauer and Link (2011; <a href="https://doi.org/10.1525/auk.2010.09220" class="external-link uri">https://doi.org/10.1525/auk.2010.09220</a>).</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                 parameters_to_save <span class="op">=</span> <span class="st">"n2"</span>,</span>
<span>                 <span class="va">...</span> <span class="op">)</span></span>
<span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                            alternate_n <span class="op">=</span> <span class="st">"n2"</span>,</span>
<span>                            <span class="va">...</span> <span class="op">)</span></span></code></pre></div>
<p>The default approach <code>parameters_to_save = c("n")</code>
slightly underestimates the uncertainty of the annual indices (slightly
narrower CI width). However, we have chosen this approach as the default
because:</p>
<ul>
<li>it much more accurately represents the observed mean counts, and so
allows for an intuitive interpretation of the annual indices;</li>
<li>it more accurately represents the relative contribution of each
stratum to the combined (e.g., continental or national) population
trajectory and trends. The alternative n2 approach tends to overestimate
the observed mean counts, and that bias varies among strata, which
affects each strata’s contribution to the combined regional
estimates.</li>
<li>the small underestimate in the uncertainty of the annual indices,
does not affect the uncertainty of the trend estimates.</li>
</ul>
<div class="section level4">
<h4 id="for-example-in-the-figures-below-the-predicted-annual-indices-blue-line-and-ci-band-are-much-more-similar-to-the-observed-average-counts-grey-dots-for-the-default-n-approach-">For example, in the figures below, the predicted annual indices
(blue line and CI-band) are much more similar to the observed average
counts (grey dots) for the Default n approach.<a class="anchor" aria-label="anchor" href="#for-example-in-the-figures-below-the-predicted-annual-indices-blue-line-and-ci-band-are-much-more-similar-to-the-observed-average-counts-grey-dots-for-the-default-n-approach-"></a>
</h4>
<p><img src="reference/figures/Alternate_n_all.png"></p>
</div>
</div>
<div class="section level3">
<h3 id="decomposing-the-population-trajectories-for-two-of-the-models">Decomposing the population trajectories for two of the models<a class="anchor" aria-label="anchor" href="#decomposing-the-population-trajectories-for-two-of-the-models"></a>
</h3>
<p>For two of the main model types <code>"slope" and "gamye"</code>,
users can choose two different ways to calculate trajectories and
population trends. With these two model types, the population
trajectories are composed of two largely independent components, a
long-term smooth and the random annual fluctuations around that smooth.
Because the two components are largely independent, the population
trajectory can be decomposed.<br>
The default approach is to include the annual fluctuations around the
linear (<code>slope</code>) or GAM-smooth (<code>gamye</code>)
components of the trajectories. These trend estimates are more
comprehensive in that they include the full estimated trajectory, but
they will vary more between subsequent years (e.g., more variability
between a 1970-2017 trend and a 1970-2018 trend), because they include
the effects of the annual fluctuations.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                 parameters_to_save <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>                 <span class="va">...</span> <span class="op">)</span></span>
<span><span class="va">indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                            alternate_n <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>                            <span class="va">...</span> <span class="op">)</span></span></code></pre></div>
<p>An alternative approach is to decompose the full trajectory and to
exclude the annual fluctuations around the linear (<code>slope</code>)
or smooth (<code>gamye</code>) components. In this case, the predicted
trends will be much more stable between subsequent years. For the CWS
status and trend analyses, the visualized population trajectories are
calculated using the full trajectory, and the trend estimates are
derived from the decomposed trajectory using only the smooth
component.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                 parameters_to_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n"</span>,<span class="st">"n3"</span><span class="op">)</span>,</span>
<span>                 <span class="va">...</span> <span class="op">)</span></span>
<span><span class="va">indices_visualize</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                                      alternate_n <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>                                      <span class="va">...</span> <span class="op">)</span></span>
<span><span class="va">indices_trend_calculation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">...</span> ,</span>
<span>                                              alternate_n <span class="op">=</span> <span class="st">"n3"</span>,</span>
<span>                                              <span class="va">...</span> <span class="op">)</span></span></code></pre></div>
<p>For example, the figure below (produced using a modified version of
the standard plotting functions), shows the two kinds of trajectories
for Pacific Wren from the 2018 CWS analysis. The light-blue trajectory
is the visualized trajectory, including the yearly fluctuations. The
orange trajectory is the one used for trend calculations, which includes
only the GAM-smooth component. For the kinds of broad-scale status
assessments that form the primary use of the published estimates of
trends, this decomposition is a particularly useful feature of these two
models.</p>
<p><img src="reference/figures/PAWR_Canada.png"></p>
<div class="section level4">
<h4 id="the-figure-below-provides-another-example-of-the-benefits-of-removing-the-year-effect-annual-fluctuations-when-calculating-trends-">The figure below provides another example of the benefits of
removing the year-effect annual fluctuations when calculating
trends.<a class="anchor" aria-label="anchor" href="#the-figure-below-provides-another-example-of-the-benefits-of-removing-the-year-effect-annual-fluctuations-when-calculating-trends-"></a>
</h4>
<p>Each point on the graph represents the 10-year trend estimate for
Wood Thrush in Canada, ending in a given year (e.g., the points at 2015
represent the species national population trend from 2005-2015). The red
and green points are the trend estimates from the default trend
estimates derived from the full population trajectories for the gamye
and slope models. The Blue points represent the trends calculated using
the decomposed trajectory of the gamye model, including only the smooth
component. When the annual fluctuations are included (SLOPE and GAMYE
including Year Effects), the population trends surpass the IUCN
trend-criterion, in some years (e.g., 2011) suggesting that if assessed
in those years the species would be listed as Threatened (trend in the
orange region). However, a more stable trend estimate from the
decomposed trajectory (GAMYE - Smooth only in Blue) shows that the
species is probably best thought of as in decline, but not surpassing
the Threatened criterion.</p>
<p><img src="reference/figures/WOTH_status_assessment.png"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="alternate-measures-of-trend-and-population-change">Alternate Measures of Trend and Population Change<a class="anchor" aria-label="anchor" href="#alternate-measures-of-trend-and-population-change"></a>
</h2>
<p>The <code><a href="../reference/generate_trends.html">generate_trends()</a></code> function produces much more than
just the trend estimates.</p>
<div class="section level3">
<h3 id="slope-trends">Slope Trends<a class="anchor" aria-label="anchor" href="#slope-trends"></a>
</h3>
<p>The default trend calculation is an interval-specific estimate of the
geometric mean annual change in the population. <span class="math inline">\(Trend = (\frac
{n[Minyear]}{n[Maxyear]})^{(1/(Maxyear-Minyear))}\)</span> It relies on
a comparison of the annual indices in the first and last years of the
trend period to quantify the mean rate of population change. However, it
ignores the pattern of change between the two end-points.</p>
<p>The user can choose an alternative estimate of change that is
calculated by fitting a log-linear slope to the series of all annual
indices between the two end-points (e.g., all 11 years in a 10-year
trend from 2008-2018). The slope of this line could be expressed as an
average annual percent change across the time-period of interest. If
working with estimates derived from a model with strong annual
fluctuations and for which no decomposition is possible (e.g.,
“firstdiff” model), this slope-based trend may be a more comprehensive
measure of the average population change, that is less dependent on the
particular end-point years. These slope trends can be added to the trend
output table by setting the <code>slope = TRUE</code> argument in
<code><a href="../reference/generate_trends.html">generate_trends()</a></code>. The standard trends are still
calculated, but additional columns are added that include the alternate
estimates. NOTE: the <code><a href="../reference/plot_map.html">plot_map()</a></code> function can map slope
trends as well with the same <code>slope = TRUE</code> argument.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>    <span class="co">#jags_data_firstdiff &lt;- prepare_jags_data(stratified_data, </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                           species_to_run = "American Kestrel",</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                           model = "firstdiff")</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#jags_mod_full_firstdiff &lt;- run_model(jags_data = jags_data)</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                               </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#firstdiff_ind &lt;- generate_indices(jags_mod = jags_mod_full_firstdiff,</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                  jags_data = jags_data_firstdiff,</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                  regions = c("continental","stratum"))</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    fd_slope_trends_08_18 <span class="ot">&lt;-</span> <span class="fu">generate_trends</span>(<span class="at">indices =</span> firstdiff_ind,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">Min_year =</span> <span class="dv">2008</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">Max_year =</span> <span class="dv">2018</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>                                             <span class="at">slope =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_map</span>(fd_slope_trends_0<span class="fl">.8</span>_18,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">slope =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">stratify_by =</span> <span class="st">"bbs_usgs"</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="er">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="percent-change-and-probability-of-change">Percent Change and probability of change<a class="anchor" aria-label="anchor" href="#percent-change-and-probability-of-change"></a>
</h3>
<p>The <code><a href="../reference/generate_trends.html">generate_trends()</a></code> function also produces estimates
of the overall percent-change in the population between the first and
last years of the trend-period. This calculation is often easier to
interpret than an average annual rate of change. These percent change
estimates have associated uncertainty bounds, and so can be helpful for
deriving statements such as “between 2008 and 2018, the population has
declined by 20 percent, but that estimate is relatively uncertain and
the true decline may be as little as 2 percent or as much as 50
percent”</p>
<p>In addition, the function can optionally calculate the posterior
conditional probability that a population has changed by at least a
certain amount, using the <code>prob_decrease</code> and
<code>prob_increase</code> arguments. These values can be useful for
deriving statements such as “our model suggests that there is a 95%
probability that the species has increased (i.e., &gt; 0% increase) and
a 45 percent probability that the species has increased more than 2-fold
(i.e., &gt; 100% increase)”</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">fd_slope_trends_08_18</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">firstdiff_ind</span>,</span>
<span>                                             Min_year <span class="op">=</span> <span class="fl">2008</span>,</span>
<span>                                             Max_year <span class="op">=</span> <span class="fl">2018</span>,</span>
<span>                                             slope <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                             prob_increase <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>                                                       </span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="custom-regional-summaries">Custom regional summaries<a class="anchor" aria-label="anchor" href="#custom-regional-summaries"></a>
</h2>
<p>Yes, you can calculate the trend and trajectories for custom
combinations of strata, such as the trends for Eastern and Western
populations of Lincoln’s Sparrow.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="co">#stratification &lt;- "bbs_cws"</span></span>
<span>    <span class="co">#strat_data &lt;- stratify(by = stratification, sample_data = TRUE)</span></span>
<span>    <span class="co">#jags_data &lt;- prepare_jags_data(strat_data, </span></span>
<span>    <span class="co">#                           species_to_run = "Lincoln's Sparrow",</span></span>
<span>    <span class="co">#                           model = "gamye")</span></span>
<span></span>
<span>    <span class="co">#jags_mod &lt;- run_model(jags_data = jags_data)</span></span></code></pre></div>
<p>Assuming the above setup has been run. The user could then generate
population trajectories using a customized grouping of the original
strata.</p>
<p>First extract a dataframe that defines the original strata used in
the analysis.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_comp_regions</span> <span class="op">&lt;-</span> <span class="fu">get_composite_regions</span><span class="op">(</span>strata_type <span class="op">=</span> <span class="va">stratification</span><span class="op">)</span></span></code></pre></div>
<p>The add a column to the dataframe that groups the original strata
into the desired custom regions.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_comp_regions</span><span class="op">$</span><span class="va">East_West</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">st_comp_regions</span><span class="op">$</span><span class="va">bcr</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">8</span>,<span class="fl">12</span><span class="op">:</span><span class="fl">14</span>,<span class="fl">22</span><span class="op">:</span><span class="fl">31</span><span class="op">)</span>,<span class="st">"East"</span>,<span class="st">"West"</span><span class="op">)</span></span></code></pre></div>
<p>st_comp_regions can now be used as the dataframe input to the
argument alt_region_names in <code><a href="../reference/generate_indices.html">generate_indices()</a></code>, with
“East_West” as the value for the argument regions. The relevant trends
can be calculated using just the <code><a href="../reference/generate_trends.html">generate_trends()</a></code>
function.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">east_west_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span>jags_mod <span class="op">=</span> <span class="va">jags_mod</span>,</span>
<span>                                      jags_data <span class="op">=</span> <span class="va">jags_data</span>,</span>
<span>                                      alt_region_names <span class="op">=</span> <span class="va">st_comp_regions</span>,</span>
<span>                                      regions <span class="op">=</span> <span class="st">"East_West"</span><span class="op">)</span></span>
<span><span class="va">east_west_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">east_west_indices</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exporting-the-jags-model">Exporting the JAGS model<a class="anchor" aria-label="anchor" href="#exporting-the-jags-model"></a>
</h2>
<p>You can easily export any of the bbsBayes models to a text file.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/copy_model_file.html">copy_model_file</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"slope"</span>,</span>
<span>              filename <span class="op">=</span> <span class="st">"my_slope_model.txt"</span><span class="op">)</span></span></code></pre></div>
<p>Then, you can modify the model text (e.g., try a different prior) and
run the modified model</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>run_model <span class="ot">&lt;-</span> <span class="cf">function</span>(... ,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">model_file_path =</span> <span class="st">"my_modified_slope_model.txt"</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                      ... )</span></code></pre></div>
<p>Details coming soon…</p>
</div>
<div class="section level2">
<h2 id="modifying-the-jags-model-and-data">Modifying the JAGS model and data<a class="anchor" aria-label="anchor" href="#modifying-the-jags-model-and-data"></a>
</h2>
<p>You can even export the bbsBayes model as text, and modify it to add
in covariates. For example a GAM smooth to estimate the effect of the
day of year on the observations, or an annual weather covariate, or…
Then add the relevant covariate data to the jags_data object, and you’re
off! We’ll add some more details and examples soon.</p>
</div>
<div class="section level2">
<h2 id="comparing-models">Comparing Models<a class="anchor" aria-label="anchor" href="#comparing-models"></a>
</h2>
<p>Finally, bbsBayes can be used to run Bayesian cross-validations. For
example, the <code>get_final_values()</code> function is useful to
provide an efficient starting point for a cross-validation runs, without
having to wait for another full burn-in period.</p>
<p>Paper that includes an example of how to implement a cross-validation
using bbsBayes.</p>
<p>Pre-print: <a href="https://doi.org/10.1101/2020.03.26.010215" class="external-link uri">https://doi.org/10.1101/2020.03.26.010215</a> Supplement: <a href="https://zenodo.org/badge/latestdoi/228419725" class="external-link"><img src="https://zenodo.org/badge/228419725.svg" alt="DOI"></a></p>
<p>NOTE: although bbsBayes includes functions to calculate WAIC, recent
work has shown that WAIC performs very poorly with the BBS data (<a href="https://doi.org/10.1650/CONDOR-17-1.1" class="external-link uri">https://doi.org/10.1650/CONDOR-17-1.1</a>). We recommend a
k-fold cross-validation approach, as in the above zenodo archive.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Brandon P.M. Edwards, Adam C. Smith, Steffi LaZerte.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
