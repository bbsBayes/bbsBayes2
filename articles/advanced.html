<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="bbsBayes2">
<title>Advanced Example • bbsBayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Example">
<meta property="og:description" content="bbsBayes2">
<meta property="og:image" content="https://bbsbayes.github.io/bbsBayes2/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">bbsBayes2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/bbsBayes2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bbsBayes/bbsBayes2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Advanced Example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bbsBayes/bbsBayes2/blob/HEAD/vignettes/articles/advanced.Rmd" class="external-link"><code>vignettes/articles/advanced.Rmd</code></a></small>
      <div class="d-none name"><code>advanced.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbsBayes/bbsBayes2" class="external-link">bbsBayes2</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span> <span class="co">#to visually check convergence</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="some-more-advanced-options">Some more advanced options<a class="anchor" aria-label="anchor" href="#some-more-advanced-options"></a>
</h2>
<p>For most of these examples, we will be using a series of saved model
outputs. These model outputs can be downloaded from this <a href="https://drive.google.com/drive/folders/1EMPqmRYjcw7aQ9rPfFoGFtgI0ELHY4Ga?usp=sharing" class="external-link">Google
Drive</a>. In the example code here, we have unzipped these saved model
outputs and stored the <em>.rds</em> files in a local sub-directory
called <em>output</em>.</p>
<div class="section level3">
<h3 id="posterior-predictive-checks">Posterior Predictive Checks<a class="anchor" aria-label="anchor" href="#posterior-predictive-checks"></a>
</h3>
<p>Posterior predictive checks are graphical comparisons of the
model-based predictions of data and the observed data. They are best
done in R, after fitting the model. It is certainly possible to modify
the Stan code to include posterior predictions of the individual BBS
counts. However, using Stan to generate these predicted counts will
almost double the size of the saved model object.</p>
<p>To generate the posterior distributions of predicted counts, you will
need to extract the posterior samples of the parameter <code>E</code> in
the bbsBayes2 models (these represent the expected values on the
log-scale). Also, if the model used the negative binomial error
distribution, then you will also need to extract the posterior samples
for the parameter <code>phi</code> (the inverse negative binomial
dispersion parameter). In the <a href="https://mc-stan.org/docs/functions-reference/neg-binom-2-log.html" class="external-link">Stan
negative binomial distribution</a>, <span class="math inline">\(\phi\)</span> is the same parameter as
<code>size</code> in <code>base::rnbinom()</code>, with arguments
<code>mu = exp(E), size = phi</code>. Here’s an example, using the
fitted model object for the Scissor-tailed Flycatcher data fit to the
<code>gamye</code> model with the ‘spatial’ variant, and the using the
<code>bbs_usgs</code> stratification.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">STFL_gamye_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/4430_gamye_spatial.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># tibble with one row for each posterior draw and one column for each parameter (i.e., each count)</span></span>
<span><span class="va">E</span> <span class="op">&lt;-</span> <span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_df.html" class="external-link">as_draws_df</a></span><span class="op">(</span><span class="va">STFL_gamye_spatial</span><span class="op">$</span><span class="va">model_fit</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"^E([[:punct:]])"</span><span class="op">)</span>,</span>
<span>         <span class="va">.draw</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Dropping 'draws_df' class as required metadata was removed.</span></span>
<span><span class="co"># tibble with 1 column for phi and one row for each posterior draw</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_df.html" class="external-link">as_draws_df</a></span><span class="op">(</span><span class="va">STFL_gamye_spatial</span><span class="op">$</span><span class="va">model_fit</span><span class="op">)</span><span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">phi</span>,</span>
<span>         <span class="va">.draw</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Dropping 'draws_df' class as required metadata was removed.</span></span>
<span></span>
<span><span class="co"># join tibbles by draw</span></span>
<span><span class="va">E</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">phi</span>,<span class="va">E</span>,</span>
<span>               by <span class="op">=</span> <span class="st">".draw"</span><span class="op">)</span></span>
<span><span class="co"># custom function to generate posterior predictive counts from negative binomial</span></span>
<span><span class="va">pred_counts_nb</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">e_mu</span>,<span class="va">phi_i</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">phi_i</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/NegBinomial.html" class="external-link">rnbinom</a></span><span class="op">(</span><span class="va">n</span>,mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">e_mu</span><span class="op">)</span>,size <span class="op">=</span> <span class="va">phi_i</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># generate predicted negative binomial counts</span></span>
<span><span class="va">y_rep</span> <span class="op">&lt;-</span> <span class="va">E</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"^E([[:punct:]])"</span><span class="op">)</span>,</span>
<span>                          <span class="op">~</span> <span class="fu">pred_counts_nb</span><span class="op">(</span><span class="va">.x</span>,<span class="va">phi</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"^E([[:punct:]])"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html" class="external-link">sample_n</a></span><span class="op">(</span><span class="va">.</span>,<span class="fl">500</span><span class="op">)</span> <span class="co"># take a random sample of 500 to simplify plotting</span></span>
<span></span>
<span><span class="co"># re-formatting to support the PPC plotting below</span></span>
<span><span class="va">y_rep</span> <span class="op">&lt;-</span> <span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_matrix.html" class="external-link">as_draws_matrix</a></span><span class="op">(</span><span class="va">y_rep</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># graphical posterior predictive check using the</span></span>
<span><span class="co"># discrete option on a cumulative distribution plot</span></span>
<span><span class="va">ppc_overplot</span> <span class="op">&lt;-</span> <span class="fu">bayesplot</span><span class="fu">::</span><span class="fu">ppc_ecdf_overlay</span><span class="op">(</span>y <span class="op">=</span> <span class="va">STFL_gamye_spatial</span><span class="op">$</span><span class="va">raw_data</span><span class="op">$</span><span class="va">count</span>,</span>
<span>                                    yrep <span class="op">=</span> <span class="va">y_rep</span>,</span>
<span>                                    discrete <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># focusing in on the range of observed data</span></span>
<span><span class="va">ppc_overplot</span> <span class="op">&lt;-</span> <span class="va">ppc_overplot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">STFL_gamye_spatial</span><span class="op">$</span><span class="va">raw_data</span><span class="op">$</span><span class="va">count</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ppc_overplot</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-5-1.png" alt="Graphical posterior predictive check overlaying the observed proportion of integer count values and the estimated proportion of count values"></p>
</div>
<div class="section level3">
<h3 id="hpdi---highest-posterior-density-intervals">HPDI - Highest posterior density intervals<a class="anchor" aria-label="anchor" href="#hpdi---highest-posterior-density-intervals"></a>
</h3>
<p>HPDI can provide a better summary of the posterior distribution than
simple quantiles of the posterior distribution. HPDI are the narrowest
interval that includes a particular portion of the posterior
probability. For symetrical posterior distributions HPDI are the same as
the Equal Density Intervals provided by taking simple quantiles of the
posterior. For skewed distributions, the HPDI is less sensitive to the
long-tail of the distribution. Annual indices of abundance (i.e., the
index values generated by <code><a href="../reference/generate_indices.html">generate_indices()</a></code>) are
retransformed predictions from a log-link model and therefore often
strongly skewed. HPDI values are not provided by default, but there is a
logical argument <code>hpdi</code> in both
<code><a href="../reference/generate_trends.html">generate_trends()</a></code> and <code><a href="../reference/generate_indices.html">generate_indices()</a></code>. For
example, in the trajectory plots below, the uncertainty bounds are more
symmetrical around the dark line in the lower plot using the HPDI than
they are in the upper plot using the default quantiles.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set of indices for demonstrating HPDI</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/4430_first_diff_spatial.rds"</span><span class="op">)</span> <span class="co"># Scissor-tailed Flycatcher</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing region continent</span></span>
<span><span class="co">#&gt; Processing region stratum</span></span>
<span><span class="va">trajectories</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span></span>
<span><span class="va">i_hpdi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">m</span>,hpdi <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing region continent</span></span>
<span><span class="co">#&gt; Processing region stratum</span></span>
<span><span class="va">trajectories_hpdi</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span><span class="va">i_hpdi</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">trajectories</span><span class="op">$</span><span class="va">US_NM_35</span> <span class="op">/</span> <span class="va">trajectories_hpdi</span><span class="op">$</span><span class="va">US_NM_35</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-6-1.png" alt="Population trajectories contrasting simple quantiles and HPDI for an example stratum. The HPDI uncertainty bound is more symetrical around the mean"></p>
</div>
<div class="section level3">
<h3 id="example---replicating-the-cws-status-and-trend-estimates-2018-version-onwards">EXAMPLE - Replicating the CWS status and trend estimates (2018
version onwards)<a class="anchor" aria-label="anchor" href="#example---replicating-the-cws-status-and-trend-estimates-2018-version-onwards"></a>
</h3>
<p>The CWS analysis, as of the 2018 BBS data-version, uses the gamye
model.</p>
<p>The full script to run the CWS analysis for the 2021 BBS data version
is accessible <a href="https://github.com/AdamCSmithCWS/CWS_BBS_2021_Analyses" class="external-link">here</a>.
Although those particular analyses were run before bbsBayes2 was
released, the basic workflow can be replicated in bbsBayes2 for a given
species as follows.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">species.eng</span> <span class="op">=</span> <span class="st">"Pacific Wren"</span></span>
<span></span>
<span><span class="va">stratified_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_cws"</span>,species<span class="op">=</span><span class="va">species.eng</span><span class="op">)</span> <span class="co">#same stratification as USGS but with BCR7 as one stratum and PEI and Nova Scotia combined into one stratum</span></span>
<span></span>
<span><span class="co"># to be included a stratum must have at least 3 routes on which the species has been observed</span></span>
<span><span class="co"># and at least one of those routes must have at least 2 years of observations</span></span>
<span><span class="va">d</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>strata_data <span class="op">=</span> <span class="va">stratified_data</span>,</span>
<span>                 min_n_routes <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                 min_max_route_years <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span></span>
<span>  prepared_data <span class="op">=</span> <span class="va">d</span>,</span>
<span>  model<span class="op">=</span><span class="st">"gamye"</span>,</span>
<span>  model_variant<span class="op">=</span><span class="st">"hier"</span>, <span class="co"># non-spatial version used in 2021</span></span>
<span>  use_pois <span class="op">=</span> <span class="cn">FALSE</span> <span class="co">#negative binomial error distribution</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod_cws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span> model_data <span class="op">=</span> <span class="va">m</span>,</span>
<span>                  refresh<span class="op">=</span><span class="fl">500</span>,</span>
<span>                      iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                      iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>                     chains <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                     parallel_chains <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example---similar-analyses-to-the-usgs-status-and-trend-estimates-2021-data-version">EXAMPLE - Similar analyses to the USGS status and trend estimates
2021 data version<a class="anchor" aria-label="anchor" href="#example---similar-analyses-to-the-usgs-status-and-trend-estimates-2021-data-version"></a>
</h3>
<blockquote>
<p>This example is approximate. The USGS analysis does NOT use the
bbsBayes2 package, nor have the analysts at the USGS confirmed that this
example would replicate their analyses.</p>
</blockquote>
<p>The USGS analyses for 2021 uses one of two different models (either
slope or first-difference) and with one of two different error
distributions (Poisson with either heavy-tailed overdispersion or
normally distributed overdispersion) (see, <a href="https://doi.org/10.1650/CONDOR-17-1.1" class="external-link">Link et al. 2017</a> and <a href="https://doi.org/10.1002/eap.2137" class="external-link">Link et al. 2020</a> for more
details).</p>
<p>Here we provide data preparation and model options to approximate the
2021 USGS bbs analyses for a species that uses the heavy-tailed Poisson
error distribution and the first-difference model (more on the error
distributions below).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">species.eng</span> <span class="op">=</span> <span class="st">"Pacific Wren"</span></span>
<span><span class="va">stratified_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_usgs"</span>,species<span class="op">=</span><span class="va">species.eng</span><span class="op">)</span></span>
<span><span class="co">#BCR by province/state/territory intersections</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span>strata_data <span class="op">=</span> <span class="va">stratified_data</span>,</span>
<span>                  min_n_routes <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                  min_max_route_years <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co">#slight difference in minimum data cut-offs</span></span>
<span></span>
<span><span class="va">m</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span>prepared_data <span class="op">=</span> <span class="va">d</span>,</span>
<span>  model<span class="op">=</span><span class="st">"first_diff"</span>,</span>
<span>  model_variant <span class="op">=</span> <span class="st">"nonhier"</span>, <span class="co">#no sharing of information among strata on abundance or trends</span></span>
<span>  use_pois <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># overdispersed, Poisson distribution</span></span>
<span>  heavy_tailed <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">#heavy-tailed (t-distribution) to model extra-Poisson dispersion</span></span>
<span> calculate_nu <span class="op">=</span> <span class="cn">TRUE</span>     <span class="co"># estimated the df parameter for the heavy-tailed t-distribution</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># MCMC settings for the usgs analyses are not published, nor would they be relevant here</span></span>
<span><span class="co"># because the official analyses use JAGS and Gibbs Sampling and not Stan's HMC algorithm</span></span>
<span><span class="co"># mod &lt;- run_model(model_data = m,</span></span>
<span><span class="co">#                  ...)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example---mapping-uncertainty-of-trends-or-estimated-abundance">ExAMPLE - mapping uncertainty of trends or estimated abundance<a class="anchor" aria-label="anchor" href="#example---mapping-uncertainty-of-trends-or-estimated-abundance"></a>
</h3>
<p>A new feature in version 1.1, is the ability to use the plot_map
function to map any of the numerical values provided in the output from
<code><a href="../reference/generate_trends.html">generate_trends()</a></code>. For example, you may be interested in
understanding the spatial distribution of the upper and lower bounds of
a trend estimate, in order to visualise the uncertainty in the spatial
distribution of trend estimates.</p>
<p>Here, we’ll demonstrate this feature using previously generate fitted
model output from applying the spatial GAMYE model to the data for Barn
Swallow (2022 data-release).</p>
<p>You can download a zip-file with a saved model output for Barn
Swallow here:</p>
<p><a href="https://drive.google.com/file/d/1RNbM312_isopRN7Lb-jP1-wK4UvRKkHE/view?usp=sharing" class="external-link">An
example of the output from applying the spatial gamye model to Barn
Swallow data</a>.</p>
<p>Unzip the file and store it in a local directory. In this example
we’ve placed it in a sub-directory of our working directory called
<em>output</em>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BARS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/Barn_Swallow_gamye_spatial.rds"</span><span class="op">)</span></span></code></pre></div>
<p>We generate annual indices of abundance using the smooth-only
component of the population trajectory. Then use those to estimate
long-term trends (1966 - 2021), and plot those trends on a map.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BARS_smooth_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">BARS</span>,</span>
<span>                                        alternate_n <span class="op">=</span> <span class="st">"n_smooth"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing region continent</span></span>
<span><span class="co">#&gt; Processing region stratum</span></span>
<span><span class="va">BARS_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span><span class="va">BARS_smooth_indices</span><span class="op">)</span></span>
<span><span class="va">BARS_trend_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">BARS_trends</span><span class="op">)</span></span>
<span><span class="va">BARS_trend_map</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-10-1.png" alt="Population trend map for Barn Swallow, showing strata with increasing trends in shades of blue and strata with decreasing trends in shades of red"></p>
<p>Then, to visualise the uncertainty in this pattern of trend
estimates, we generate two maps that each display the upper and lower
credible intervals of the trends. We can interpret these maps as showing
the lower-bound and the upper-bound on the rates of population change
for the species. For example, we can be reasonably confident that the
species’ trends have not been more negative than the map on the left,
and are unlikely to be more positive than the map on the right.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">BARS_trend_map_lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">BARS_trends</span>, alternate_column <span class="op">=</span> <span class="st">"trend_q_0.05"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Lower bound on trend"</span><span class="op">)</span></span>
<span><span class="va">BARS_trend_map_upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">BARS_trends</span>, alternate_column <span class="op">=</span> <span class="st">"trend_q_0.95"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Upper bound on trend"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="co">#removing the second legend</span></span>
<span><span class="co"># combined using the patchwork package</span></span>
<span><span class="va">BARS_trend_bounds_maps</span> <span class="op">&lt;-</span> <span class="va">BARS_trend_map_lower</span> <span class="op">+</span> <span class="va">BARS_trend_map_upper</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span>
<span><span class="va">BARS_trend_bounds_maps</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-11-1.png" alt="Population trend maps for Barn Swallow, showing the lower and upper bounds on the population trends, where strata with increasing trends are shown in shades of blue and strata with decreasing trends in shades of red"></p>
<p>Alternatively, we could visualise the width of the credible interval
on the trends. Here we see that most of the trend estimates have
credible intervals that are narrower than approximately 2%/year, but
trends for a few strata in northern regions and the south-west are less
precise. Note: Because in this case we are not displaying estimates of
trends specifically, the function uses the viridis colour scale.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">BARS_trend_map_CI_width</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">BARS_trends</span>, alternate_column <span class="op">=</span> <span class="st">"width_of_95_percent_credible_interval"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">BARS_trend_map_CI_width</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-12-1.png" alt="Map of the width of the credible interval on trend estimates for Barn Swallow"></p>
</div>
<div class="section level3">
<h3 id="advanced-options-and-customized-models">Advanced options and customized models<a class="anchor" aria-label="anchor" href="#advanced-options-and-customized-models"></a>
</h3>
</div>
<div class="section level3">
<h3 id="alternate-error-distributions">Alternate error distributions<a class="anchor" aria-label="anchor" href="#alternate-error-distributions"></a>
</h3>
<p>Error distributions in the bbsBayes2 models can be accessed using a
combination of three arguments in the <code>?prepare_model()</code>
function.</p>
<div class="section level4">
<h4 id="poisson-vs-negative-binomial">Poisson vs negative binomial<a class="anchor" aria-label="anchor" href="#poisson-vs-negative-binomial"></a>
</h4>
<p>For all of the models, the BBS counts on a given route and year can
be modeled using either an over-dispersed Poisson distribution or a
negative binomial distribution. This selection is controlled using the
<code>use_pois</code> argument. The negative binomial is the default
<code>use_pois = FALSE</code>, because it greatly reduces memory
requirements and the size of the object created using
<code><a href="../reference/run_model.html">run_model()</a></code>. If using the negative binomial distribution,
no other arguments need to be set.</p>
<p>If a user wishes to use the over-dispersed Poisson distribution to
model the error distribution of BBS counts, then set
<code>prepare_model(..., use_pois = TRUE)</code>. This approach
generates a count-level random effect to account for extra-Poisson
variance, following the approaches used in most of the official BBS
analyses. These count-level parameter estimates are the reason for the
increase in memory requirements and object size when fitting the model
(i.e., they require monitoring an additional parameter for every
observation in the dataset). If using the Poisson option, there are two
additional arguments that the user can select to control some of the
specifics of the over-dispersion. The first argument allows the user to
select between a normal distribution (<code>heavy_tailed = FALSE</code>)
to model the count-level random effects or the default heavier-tailed
t-distribution (<code>heavy_tailed = TRUE</code>). Finally, if the
heavy-tailed t-distribution is selected, then the user can choose to
either estimate the degrees of freedom for the t-distribution
<code>calculate_nu = TRUE</code> letting the model estimate the
heaviness of the tails, or to have the t-distribution fixed at 3
<code>calculate_nu = FALSE</code> implying very heavy-tails relative to
the normal. We have used the <code>calculate_nu = FALSE</code> as the
default because for many species estimating the degrees of freedom
greatly increases the model run-times.</p>
</div>
</div>
<div class="section level3">
<h3 id="alternate-measures-of-trend-and-population-change">Alternate Measures of Trend and Population Change<a class="anchor" aria-label="anchor" href="#alternate-measures-of-trend-and-population-change"></a>
</h3>
<p>The <code><a href="../reference/generate_trends.html">generate_trends()</a></code> function produces much more than
just the trend estimates. This section explains one alternate measure of
trend (i.e., <em>slope trends</em>) and measures of population change,
such as the percent change in the population between the first and last
years of the trend and the probability that a population has decreased
by a certain amount.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set of indices for demonstrating trend options</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/4430_first_diff_spatial.rds"</span><span class="op">)</span> <span class="co"># Scissor-tailed Flycatcher</span></span>
<span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing region continent</span></span>
<span><span class="co">#&gt; Processing region stratum</span></span></code></pre></div>
<div class="section level4">
<h4 id="the-default-trend-estimate">The default trend estimate<a class="anchor" aria-label="anchor" href="#the-default-trend-estimate"></a>
</h4>
<p>The default trend calculation is an interval-specific estimate of the
geometric mean annual change in the population. <span class="math inline">\(Trend = (\frac
{n[min-year]}{n[max-year]})^{(1/(max-year-min-year))}\)</span> We refer
to these as <em>end-point trends</em>. They rely on a comparison of the
annual indices in the first and last years of the trend period to
quantify the mean rate of population change. However, it ignores the
pattern of change between the two end-points.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span><span class="va">i</span>,</span>
<span>                     slope <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     min_year <span class="op">=</span> <span class="fl">1980</span><span class="op">)</span> <span class="co">#trends from 1980-2021</span></span>
<span><span class="va">t_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t_map</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-14-1.png" alt="Map of population trends for Scissor-tailed Flycatcher from 1980-2021, using the default end-point trend estimates"></p>
</div>
<div class="section level4">
<h4 id="slope-based-trends">Slope-based Trends<a class="anchor" aria-label="anchor" href="#slope-based-trends"></a>
</h4>
<p>bbsBayes2 includes an alternate trend estimate that can be applied to
any of the models to dampen the influence of the start and end years on
the estimated trend. These slope-based trends are calculated by fitting
a log-linear slope to the series of all annual indices between the two
end-points (e.g., all 11 years in a 10-year trend from 2011-2021). We
refer to these trends as <em>slope-based trends</em>. The slope of this
line is transformed into an average annual percent change across the
time-period of interest. Fslope-based trend may be useful for estimates
derived from a model and or a species with strong annual fluctuations
when the user wishes to account for the overall pattern of the annual
fluctuations in the trend estimate without letting the trend be
completely determined by the annual fluctuations in the particular
end-point years. These slope trends can be added to the trend output
table by setting the <code>slope = TRUE</code> argument in
<code><a href="../reference/generate_trends.html">generate_trends()</a></code>. The default <em>end-point trends</em>
are still calculated, but additional columns are added that include the
alternate estimates. NOTE: the <code><a href="../reference/plot_map.html">plot_map()</a></code> function can map
slope trends as well with the same <code>slope = TRUE</code>
argument.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">t_map_slope</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">t</span>,</span>
<span>                        slope <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t_map_slope</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-15-1.png" alt="Map of population trends for Scissor-tailed Flycatcher from 1980-2021, using the slope-based trend estimates"></p>
</div>
<div class="section level4">
<h4 id="percent-change-and-probability-of-change">Percent Change and probability of change<a class="anchor" aria-label="anchor" href="#percent-change-and-probability-of-change"></a>
</h4>
<p>The <code><a href="../reference/generate_trends.html">generate_trends()</a></code> function produces estimates of the
overall percent-change in the population between the first and last
years of the trend-period, by default. This calculation may be easier to
interpret than an average annual rate of change. These percent change
estimates have associated uncertainty bounds, and so can be helpful for
deriving statements such as “between 2008 and 2018, the population has
declined by 20 percent, but that estimate is relatively uncertain and
the true decline may be as little as 2 percent or as much as 50
percent”</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span></span>
<span><span class="va">t</span><span class="op">$</span><span class="va">trends</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"region"</span>,<span class="st">"percent_change"</span>,<span class="st">"percent_change_q_0.95"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   region    percent_change percent_change_q_0.95</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;              &lt;dbl&gt;                 &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 continent          -46.8                 -39.8</span></span></code></pre></div>
<p>In addition, the function can optionally calculate the posterior
conditional probability that a population has changed more or less than
some user-defined threshold(s), using the <code>prob_decrease</code> and
<code>prob_increase</code> arguments. The calculate the conditional
probability a species population has decreased, set the argument
<code>prob_decrease = 0</code>. Similarly if you want to know the
conditaional probability that the population has decreased by more than
50% use <code>prob_decrease = 50</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span><span class="va">i</span>,</span>
<span>                     prob_decrease <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="co"># two thresholds</span></span>
<span></span>
<span><span class="va">t</span><span class="op">$</span><span class="va">trends</span><span class="op">[</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"region"</span>,<span class="st">"prob_decrease_0_percent"</span>,<span class="st">"prob_decrease_50_percent"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   region    prob_decrease_0_percent prob_decrease_50_percent</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;                       &lt;dbl&gt;                    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 continent                       1                    0.208</span></span></code></pre></div>
<p>These values can be useful for deriving statements such as “the
first-difference spatial model suggests that it is extremely likely that
the Scissor-tailed Flycatcher population monitored by the BBS has
decreased between 1966 and 2021 (prob_decrease_0_percent &gt; 0.999),
and that there is an approximate 21% probability that the species has
decreased by at least 50% in that same time period
(prob_decrease_50-percent = 0.20775)”.</p>
</div>
</div>
<div class="section level3">
<h3 id="custom-regional-summaries">Custom regional summaries<a class="anchor" aria-label="anchor" href="#custom-regional-summaries"></a>
</h3>
<p>Yes, you can calculate the trend and trajectories for custom
combinations of strata, such as the trends for some largely arbitrary
groupings of Bird Conservation Regions based approximately on the
northern and southern portions of the Barn Swallow’s range.</p>
<p>First we load a <a href="https://drive.google.com/file/d/1hlJ9rljDSGdkV4P_-k07wBSyWyKOy-hm/view?usp=drive_link" class="external-link">fitted
model object for Barn Swallow</a>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">BARS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/Barn_Swallow_first_diff_spatial.rds"</span><span class="op">)</span></span></code></pre></div>
<p>Then we extract the strata list from the fitted model object and
define a new column <em>north_south</em> that identifies which strata
belong in each of our new composite regions (<em>North</em> or
<em>South</em>)</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">comp_regions</span> <span class="op">&lt;-</span> <span class="va">BARS</span><span class="op">$</span><span class="va">meta_strata</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>north_south <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">bcr</span> <span class="op">&lt;</span> <span class="fl">15</span>, <span class="st">"North"</span>,<span class="st">"South"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">i_BARS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">BARS</span>,</span>
<span>                           regions_index <span class="op">=</span> <span class="va">comp_regions</span>, <span class="co"># new data frame to identify which strata are in composite regions</span></span>
<span>                           regions <span class="op">=</span> <span class="st">"north_south"</span><span class="op">)</span> <span class="co"># column in data frame with composite region names</span></span>
<span><span class="co">#&gt; Processing region north_south</span></span>
<span></span>
<span><span class="va">trajectories</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span><span class="va">i_BARS</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">trajectories</span><span class="op">[[</span><span class="st">"North"</span><span class="op">]</span><span class="op">]</span> <span class="op">/</span> <span class="va">trajectories</span><span class="op">[[</span><span class="st">"South"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-19-1.png" alt="Population trajectories for Barn Swallow in the northern and southern parts of their range"></p>
</div>
<div class="section level3">
<h3 id="exporting-and-modifying-the-stan-models">Exporting and modifying the Stan models<a class="anchor" aria-label="anchor" href="#exporting-and-modifying-the-stan-models"></a>
</h3>
<p>You can easily export any of the bbsBayes2 models to a text file
(file extension .Stan).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="../reference/copy_model_file.html">copy_model_file</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"gamye"</span>,</span>
<span>                model_variant <span class="op">=</span> <span class="st">"hier"</span>,</span>
<span>                dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co">#writes the stan file to working directory</span></span></code></pre></div>
<p>Then, you can modify the model text (e.g., try a different prior) and
run the modified model. To modify the model, you can open the saved
.stan file (RStudio has good support for Stan model syntax), make
modifications to the model, then re-save the file.</p>
<p>If you are not familiar with writing Stan code, you will want to be
very careful modifying the bbsBayes2 models; The model files are
relatively long and include some complicated components (conditional
statements, transformed parameters and transformed data). However, there
are excellent <a href="https://mc-stan.org/users/documentation/tutorials" class="external-link">online sources
for getting comfortable with working in Stan</a>, and this package
exists in a large part to allow users to explore, modify, elaborate, and
understand these models. So be brave, be careful, be open, and contact
the package authors if you get stuck. We promise to be friendly and to
do our best to help.</p>
<p>After modifying the .stan file, you can use bbsBayes2 to fit the data
to the modified model using the <code>model_file</code> argment in
<code><a href="../reference/prepare_model.html">prepare_model()</a></code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">prep</span><span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"gamye"</span>, model_variant <span class="op">=</span> <span class="st">"spatial"</span>,</span>
<span>        model_file<span class="op">=</span><span class="st">"gamye_hier_bbs_CV_COPY.stan"</span>,</span>
<span>         <span class="va">...</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">prep</span>,<span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example---modifying-a-model-to-include-a-covariate">Example - modifying a model to include a covariate<a class="anchor" aria-label="anchor" href="#example---modifying-a-model-to-include-a-covariate"></a>
</h3>
<p>With some experience writing Stan code, there are limitless options
to modify the base bbsBayes2 models and fit them using the package
functions. For example, the bbsBayes models are designed to estimate how
bird populations have changed in time and space. But with modifications
to include predictors on the aspects of population change, they could
also serve to estimate <strong>why</strong> pouplations have changed.
Other very simple modifications could be to change the priors on
particular parameters. We have used priors on the time-series components
of these models that are somewhat informative. Based on the observed
temporal and spatial variation from 50-years of monitoring bird
populations with the BBS and the Christmas Bird Count. But some users
may want priors that are less, or more, informative. See the
supplementals associated with this pre-print, <a href="https://doi.org/10.32942/X2088D" class="external-link">Smith et al. 2023</a>, for more
information on these priors.</p>
<div class="section level4">
<h4 id="viewing-and-exporting-the-stan-code-for-the-models">viewing and exporting the Stan code for the models<a class="anchor" aria-label="anchor" href="#viewing-and-exporting-the-stan-code-for-the-models"></a>
</h4>
<p>The <code><a href="../reference/copy_model_file.html">copy_model_file()</a></code> function writes a text file to a
local directory containing the full Stan code for the selected bbsBayes2
model.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># writes a copy of the spatial slope model to the working directory</span></span>
<span><span class="fu"><a href="../reference/copy_model_file.html">copy_model_file</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"gamye"</span>, model_variant <span class="op">=</span> <span class="st">"spatial"</span>, dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="adding-the-necessary-stan-code">Adding the necessary Stan code<a class="anchor" aria-label="anchor" href="#adding-the-necessary-stan-code"></a>
</h4>
<p>Once copied, the model file can be modified by hand to include
different priors, new parameters, etc. RStudio has good support for Stan
code. For example, the following code components were added to the text
of the Stan file writen using the <code><a href="../reference/copy_model_file.html">copy_model_file()</a></code>
function above. THese modifications create a model that takes a matrix
of strata by year values of annual spring-moisture, and uses them as a
predictor on the year-effects in a gamye model. Conceptually, a model
that uses the moisture information to help estimate the annual
fluctuations around the long-term smooth of the GAM component of the
model. This particular modification is inspired by a project to
understand the longer-term trends of wetland birds that are not a
function of local fluctuations in moisture. The lines below were added
to the “data”, “parameters”, “transformed parameters”, and “model”
sections of the Stan code, then saved as a new file, e.g.,
“gamye_spatial_bbs_CV_year_effect_covariate.stan”.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## modify the model to add the following lines in each of the indicated sections</span></span>
<span><span class="co">## of the Stan mdoel</span></span>
<span><span class="co"># data {</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co">#   // covariate data</span></span>
<span><span class="co">#   array[n_strata,n_years] real cov;   // covariate data annual moisture by strata</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># parameters {</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co"># // covariate parameter</span></span>
<span><span class="co">#  real beta_cov; //coefficient of covariate effect on annual fluctuations</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># transformed parameters {</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co">#   // yeareffects as an additive combination of a random fluctuation</span></span>
<span><span class="co">#   // and the simple linear effect of the annual moisture covariate</span></span>
<span><span class="co">#   // may not be sufficient data to estimate both, in which case</span></span>
<span><span class="co">#   // consider removing yeareffect_raw and sdyear</span></span>
<span><span class="co">#   for(s in 1:n_strata){</span></span>
<span><span class="co">#     yeareffect[s,] = sdyear[s]*yeareffect_raw[s,] + beta_cov*cov[s,];</span></span>
<span><span class="co">#   }</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># model {</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co">#   // covariate effect</span></span>
<span><span class="co">#   beta_cov ~ normal(0,1); //prior for covariate effect</span></span>
<span><span class="co">#   ...</span></span>
<span><span class="co"># }</span></span></code></pre></div>
<p>Once the model is saved, the only other necessary modification is to
add the covariate data to the data list supplied to
<code>prepare_model</code></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">## Not Run</span></span>
<span><span class="co">## example code, but the covariate data are not included</span></span>
<span></span>
<span></span>
<span><span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"Black Tern"</span></span>
<span><span class="va">stratification</span> <span class="op">&lt;-</span> <span class="st">"latlong"</span></span>
<span><span class="va">strata_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span><span class="va">stratification</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># setting up a spatial object to filter the data to one BCR</span></span>
<span><span class="va">bcr_11</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span><span class="st">"bcr"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">strata_name</span> <span class="op">==</span> <span class="st">"BCR11"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">.</span>,<span class="fl">50000</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># 50 km buffer to catch all possible BBS routes</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>bcr <span class="op">=</span> <span class="va">strata_name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">bcr</span><span class="op">)</span></span>
<span><span class="co"># filtering the strata_map to just BCR 11 (Prairie Potholes)</span></span>
<span><span class="va">strata_sel</span> <span class="op">&lt;-</span> <span class="va">strata_map</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">bcr_11</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model</span> <span class="op">=</span> <span class="st">"gamye"</span></span>
<span></span>
<span><span class="va">model_variant</span> <span class="op">&lt;-</span> <span class="st">"spatial"</span></span>
<span><span class="co"># stratifying with custom stratification</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"latlong_bcr11"</span>,</span>
<span>              strata_custom <span class="op">=</span> <span class="va">strata_sel</span>,</span>
<span>              species <span class="op">=</span> <span class="va">species</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">s</span>,</span>
<span>                  min_n_routes <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                  min_max_route_years <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="co">#filtering to strata with more observations</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_spatial.html">prepare_spatial</a></span><span class="op">(</span><span class="va">p</span>,</span>
<span>                      strata_map <span class="op">=</span> <span class="va">strata_sel</span><span class="op">)</span></span>
<span><span class="co"># string identifying the customized model file</span></span>
<span> <span class="va">cov_mod</span> <span class="op">&lt;-</span> <span class="st">"gamye_spatial_bbs_CV_year_effect_covariate.stan"</span></span>
<span></span>
<span> <span class="co"># preparing the model</span></span>
<span><span class="va">pm_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">ps</span>,</span>
<span>                        model <span class="op">=</span> <span class="va">model</span>,</span>
<span>                        model_variant <span class="op">=</span> <span class="va">model_variant</span>,</span>
<span>                        model_file <span class="op">=</span> <span class="va">cov_mod</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># reading in the moisture covariate data</span></span>
<span> <span class="va">cov_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"data/annual_latlong_june_spei03.rds"</span><span class="op">)</span> <span class="co"># the covariate data</span></span>
<span></span>
<span><span class="va">strata_incl</span> <span class="op">&lt;-</span> <span class="va">ps</span><span class="op">$</span><span class="va">meta_strata</span> <span class="co"># data frame with strata included in the data</span></span>
<span><span class="va">years_incl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ps</span><span class="op">$</span><span class="va">raw_data</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="op">:</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ps</span><span class="op">$</span><span class="va">raw_data</span><span class="op">$</span><span class="va">year</span><span class="op">)</span> <span class="co"># vector of the years available</span></span>
<span></span>
<span><span class="co"># Creating the covariate matrix to send to Stan</span></span>
<span><span class="va">cov_incl</span> <span class="op">&lt;-</span>  <span class="va">strata_incl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">cov_all</span>,</span>
<span>             by <span class="op">=</span> <span class="st">"strata_name"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># dropping covariates outside of the included strata</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">years_incl</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         <span class="va">strata</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">#dropping the covariates outside of the years included</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">strata</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># sorting to match strata ordering</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">strata</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co"># dropping non-covariate column</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># formating as numerical matrix</span></span>
<span></span>
<span><span class="co">## adding the covariate matrix to the model_data object in the</span></span>
<span><span class="co">## object created by prepare_model()</span></span>
<span><span class="va">pm_cov</span><span class="op">$</span><span class="va">model_data</span><span class="op">[[</span><span class="st">"cov"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cov_incl</span></span>
<span></span>
<span><span class="co"># fitting the model using run_model()</span></span>
<span><span class="va">fit_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">pm_cov</span>,</span>
<span>                 refresh <span class="op">=</span> <span class="fl">200</span>,</span>
<span>                 iter_warmup <span class="op">=</span> <span class="fl">2000</span>, <span class="co">#increasing the warmup to support more complex model</span></span>
<span>                 iter_sampling <span class="op">=</span> <span class="fl">4000</span>, <span class="co"># increasing the sampling</span></span>
<span>                 thin <span class="op">=</span> <span class="fl">2</span>, <span class="co"># small thinning to reduce output file size</span></span>
<span>                 max_treedepth <span class="op">=</span> <span class="fl">11</span>, <span class="co"># also increased to support more complex model</span></span>
<span>                 adapt_delta <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>                 output_dir <span class="op">=</span> <span class="st">"output"</span>, <span class="co">#saving model in a particular directory</span></span>
<span>                 output_basename <span class="op">=</span> <span class="st">"covariate"</span><span class="op">)</span> <span class="co">#saving model output with a relevant name</span></span>
<span></span>
<span><span class="co"># posterior summary and convergence of the covariate effect</span></span>
<span><span class="va">cov_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_summary.html">get_summary</a></span><span class="op">(</span><span class="va">fit_cov</span>, variable <span class="op">=</span> <span class="st">"beta_cov"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="comparing-models">Comparing Models<a class="anchor" aria-label="anchor" href="#comparing-models"></a>
</h3>
<div class="section level4">
<h4 id="calculating-the-approximate-loo-cv">Calculating the approximate loo-cv<a class="anchor" aria-label="anchor" href="#calculating-the-approximate-loo-cv"></a>
</h4>
<p>The models include an option to calculate the point-wise
log-likelihood of each count given the model and parameter estimates.
With the argument <code>calculate_log_lik = TRUE</code>, in the
<code><a href="../reference/prepare_model.html">prepare_model()</a></code> function, this option allows for the use of
the <code><a href="https://mc-stan.org/cmdstanr/reference/fit-method-loo.html" class="external-link">cmdstanr::loo()</a></code> function to calculate approximate
leave-one-out cross-validation statistics. Some caveats and
warnings:</p>
<ol style="list-style-type: decimal">
<li><p>Using the approximate loo-cv to assess models and/or compare
alternate models requires some strong assumptions that the user should
be very aware of. Importantly, leave one out cross-validation assumes
that individual observations are conditionally independent. Given the
rich nested dependencies of the BBS data (non-independence of
observations within observers, routes, strata, and years), this
assumption may be questionable.</p></li>
<li><p>Observation-level random effects (i.e., if
<code>use_pois = TRUE</code>) are often extremely flexible and result in
very poor diagnostics for approximate loo calculations.</p></li>
<li><p>Adding an observation-level log_likelihood calculation greatly
increases the memory requirements and size of the saved model
objects.</p></li>
</ol>
<p>Here’s an example using Baird’s Sparrow, a species with a restricted
range and so the models fit reasonably quickly (approximately 1-hour
each) and adding the count-level log_lik parameter doesn’t add too much
to the file size. Here we compare the approximate leave-one-out
cross-validation estimate between the ‘gamye’ and the ‘first_diff’
models.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span><span class="st">"latlong"</span>,<span class="st">"Baird's Sparrow"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">s</span>, min_n_routes <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">map</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span>stratify_by <span class="op">=</span> <span class="st">"latlong"</span><span class="op">)</span></span>
<span><span class="va">sp</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/prepare_spatial.html">prepare_spatial</a></span><span class="op">(</span><span class="va">p</span>,<span class="va">map</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># first difference</span></span>
<span><span class="va">mp_first_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">sp</span>, model <span class="op">=</span> <span class="st">"first_diff"</span>,model_variant <span class="op">=</span> <span class="st">"spatial"</span>,</span>
<span>                               calculate_log_lik <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">m_first_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">mp_first_diff</span>,</span>
<span>                          iter_sampling <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">m_first_diff</span>,<span class="st">"output/BASP_latlong_first_diff_spatial.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># gamye</span></span>
<span><span class="va">mp_gamye</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">sp</span>, model <span class="op">=</span> <span class="st">"gamye"</span>,model_variant <span class="op">=</span> <span class="st">"spatial"</span>,</span>
<span>                          calculate_log_lik <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">m_gamye</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">mp_gamye</span>,</span>
<span>                     iter_sampling <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">m_gamye</span>,<span class="st">"output/BASP_latlong_gamye_spatial.rds"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">m_gamye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/BASP_latlong_gamye_spatial.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_first_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/BASP_latlong_first_diff_spatial.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># install.packages("loo") # you may need to install this package</span></span>
<span><span class="va">loo_gamye</span> <span class="op">&lt;-</span> <span class="va">m_gamye</span><span class="op">$</span><span class="va">model_fit</span><span class="op">$</span><span class="fu">loo</span><span class="op">(</span><span class="op">)</span><span class="co"># loo calculations using the functions built into the cmdstanr model-fit object</span></span>
<span><span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="va">loo_first_diff</span> <span class="op">&lt;-</span> <span class="va">m_first_diff</span><span class="op">$</span><span class="va">model_fit</span><span class="op">$</span><span class="fu">loo</span><span class="op">(</span><span class="op">)</span><span class="co"># loo calculations using the functions built into the cmdstanr model-fit object</span></span>
<span><span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span>
<span></span>
<span></span>
<span><span class="va">loo_gamye</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed from 8000 by 4368 log-likelihood matrix</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate    SE</span></span>
<span><span class="co">#&gt; elpd_loo  -7095.6 106.3</span></span>
<span><span class="co">#&gt; p_loo       682.1  26.7</span></span>
<span><span class="co">#&gt; looic     14191.2 212.5</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; Monte Carlo SE of elpd_loo is NA.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pareto k diagnostic values:</span></span>
<span><span class="co">#&gt;                          Count Pct.    Min. n_eff</span></span>
<span><span class="co">#&gt; (-Inf, 0.5]   (good)     3936  90.1%   576       </span></span>
<span><span class="co">#&gt;  (0.5, 0.7]   (ok)        298   6.8%   186       </span></span>
<span><span class="co">#&gt;    (0.7, 1]   (bad)       112   2.6%   14        </span></span>
<span><span class="co">#&gt;    (1, Inf)   (very bad)   22   0.5%   5         </span></span>
<span><span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="va">loo_first_diff</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed from 8000 by 4368 log-likelihood matrix</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate    SE</span></span>
<span><span class="co">#&gt; elpd_loo  -6976.8 105.3</span></span>
<span><span class="co">#&gt; p_loo       778.8  26.2</span></span>
<span><span class="co">#&gt; looic     13953.7 210.7</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; Monte Carlo SE of elpd_loo is NA.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pareto k diagnostic values:</span></span>
<span><span class="co">#&gt;                          Count Pct.    Min. n_eff</span></span>
<span><span class="co">#&gt; (-Inf, 0.5]   (good)     3913  89.6%   509       </span></span>
<span><span class="co">#&gt;  (0.5, 0.7]   (ok)        307   7.0%   177       </span></span>
<span><span class="co">#&gt;    (0.7, 1]   (bad)       130   3.0%   13        </span></span>
<span><span class="co">#&gt;    (1, Inf)   (very bad)   18   0.4%   4         </span></span>
<span><span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></span></code></pre></div>
<p>This approximation of leave-one-out crossvalidation suggests that the
first-difference model may slightly out-perform the gamye model for this
species and time-period. However, the uncertainty in the calculation of
loo is relatively wide and the estimates for the two models are only
about 1 SD apart. In addition, the ‘pareto-k’ warnings suggest that the
approximation may not be accurate for some of the BBS counts. These
approximations of cross-validation results can be very useful, because
they only require fitting the model once. However, they are
approximations and they do not fully respect the spatial and temporal
structure of the BBS data. Contrast this approximation of leave-one-out
cross-validation with the following k-fold cross-validation that also
accounts for some of the nested and hierarchical structures of the BBS
data.</p>
</div>
<div class="section level4">
<h4 id="k-fold-cross-validation">K-fold Cross-Validation<a class="anchor" aria-label="anchor" href="#k-fold-cross-validation"></a>
</h4>
<p>Bayesian model assessment is an open area of research. We have
included some experimental features to allow for one approach to
cross-validation. These features are experimental and so users should be
cautious and be confident that they understand what they’re doing. For
cross-validation, the <code><a href="../reference/prepare_model.html">prepare_model()</a></code> function can be used
to define which observations are part of a test set and which are part
of a training set.</p>
<p>To use the method implemented by bbsBayes2, we’ll specify
<code>calculate_cv</code> as <code>TRUE</code> during the
<code><a href="../reference/prepare_model.html">prepare_model()</a></code> step. By default, this will prepare 10 test
sets (K-folds, <code>cv_k</code>) using <code>obs_n</code> as the
blocking variable (<code>cv_fold_groups</code>) and omitting groups with
only single observations (<code>cv_omit_singles</code>). The blocking
respects the hierarchical structure of the BBS data. It ensures that all
of the routes, observers are retained in each of the training folds, and
so that each of the k-fold model fits can generate predictions for all
of the routes and observers in the test fold. Conceptually, this default
blocking approach results in out-of-sample predictions that represent
all future counts for a given observer (a random sample of observers in
each of the k folds), other than that observer’s first year of
observations on each route they have ever contributed to. Rephrased, the
cross-validation compares the ability of the model (or the two models
being compared) to accurately predict the future observations of each
observer and route combination. The ‘cv_omit_singles’ argument by
default excludes the observers that have only every contributed a single
BBS observation from the cross-validation exercise (they are never
included in the test fold, because there are no “future” observations to
predict for these observers).</p>
<p>First we use exactly the same data preparation steps to match the cv
approximation above.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span><span class="st">"latlong"</span>,<span class="st">"Baird's Sparrow"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">s</span>, min_n_routes <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">map</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span>stratify_by <span class="op">=</span> <span class="st">"latlong"</span><span class="op">)</span></span>
<span><span class="va">sp</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/prepare_spatial.html">prepare_spatial</a></span><span class="op">(</span><span class="va">p</span>,<span class="va">map</span><span class="op">)</span></span></code></pre></div>
<p>Then we prepare the models to identify the training and testing
folds.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">m_gamye</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">sp</span>,<span class="st">"gamye"</span>,</span>
<span>                        calculate_cv <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_first_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">sp</span>,<span class="st">"first_diff"</span>,</span>
<span>                        calculate_cv <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The <code>calculate_cv = TRUE</code> argument adds the calculation of
a vector of derived parameters, “log_lik_cv[1:ntest]” that represent the
predicted counts from the model for each of the observed counts in the
testing dataset (i.e., the observed counts that were held out of the
training dataset). So these are true out-of-sample predictions for
counts with known values. The “log_lik_cv” values represent the log
posterior predictive density (sometimes called lppd) or the
log-likelihood of the observed data, given the fitted model and the data
in the training set. They are logs of probability values, and so are
always negative, and higher values (values closer to 0) indicate better
fit.</p>
<p>And finally, we fit each of the models k-times. <strong>Yes, this
will take a while</strong> We are fitting 20 models in total here. So
fire it up on a Friday afternoon and we’ll come back to it on Monday
morning.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## fitting the gamye</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">m_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">m_gamye</span>,</span>
<span>                     refresh <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                     k <span class="op">=</span> <span class="va">k</span>, <span class="co"># this tells run_model which fold to use as the test</span></span>
<span>                     output_dir <span class="op">=</span> <span class="st">"output"</span>, <span class="co">#saving the output in a directory</span></span>
<span>                     output_basename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m_gamye_"</span>,<span class="va">k</span>,<span class="st">"_.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_summary.html">get_summary</a></span><span class="op">(</span><span class="va">m_tmp</span>,variables <span class="op">=</span> <span class="st">"log_lik_cv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># identifying which counts are being predicted in each fold using the</span></span>
<span><span class="co"># "test" vector in the original model data</span></span>
<span>  <span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="va">sum_cv</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>original_count_index <span class="op">=</span> <span class="va">m_tmp</span><span class="op">$</span><span class="va">model_data</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">sum_cv</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"output/cv_sum_gamye"</span>,<span class="st">"_"</span>,<span class="va">k</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## fitting the first_diff</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">m_tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">m_first_diff</span>,</span>
<span>                     refresh <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                     k <span class="op">=</span> <span class="va">k</span>, <span class="co"># this tells run_model which fold to use as the test</span></span>
<span>                     output_dir <span class="op">=</span> <span class="st">"output"</span>, <span class="co">#saving the output in a directory</span></span>
<span>                     output_basename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"m_first_diff_"</span>,<span class="va">k</span>,<span class="st">"_.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_summary.html">get_summary</a></span><span class="op">(</span><span class="va">m_tmp</span>,variables <span class="op">=</span> <span class="st">"log_lik_cv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># identifying which counts are being predicted in each fold using the</span></span>
<span><span class="co"># "test" vector in the original model data</span></span>
<span>  <span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="va">sum_cv</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>original_count_index <span class="op">=</span> <span class="va">m_tmp</span><span class="op">$</span><span class="va">model_data</span><span class="op">$</span><span class="va">test</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">sum_cv</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"output/cv_sum_first_diff"</span>,<span class="st">"_"</span>,<span class="va">k</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now that it’s Monday morning. We want to combine the results for each
model and each of the k-folds.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">orig_data</span> <span class="op">&lt;-</span> <span class="va">m_gamye</span><span class="op">$</span><span class="va">raw_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>folds <span class="op">=</span> <span class="va">m_gamye</span><span class="op">$</span><span class="va">folds</span>,</span>
<span>         original_count_index <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">wide_cv</span> <span class="op">&lt;-</span> <span class="va">orig_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">original_count_index</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">mod_sel</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gamye"</span>,<span class="st">"first_diff"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">wide_cvt</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"output/cv_sum_"</span>,<span class="va">mod_sel</span>,<span class="st">"_"</span>,<span class="va">k</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">mod_sel</span><span class="op">)</span></span>
<span>  <span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">sum_cv</span>,<span class="va">tmp</span><span class="op">)</span></span>
<span>  <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">tmp</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">original_count_index</span>,<span class="va">mean</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename_with</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"mean"</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"log_lik_"</span>,<span class="va">mod_sel</span><span class="op">)</span>,<span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">wide_cvt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">wide_cvt</span>,<span class="va">tmp</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span>  <span class="va">wide_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">wide_cv</span>,<span class="va">wide_cvt</span>,</span>
<span>                       by <span class="op">=</span> <span class="st">"original_count_index"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="va">sum_cv</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">orig_data</span>,</span>
<span>            by <span class="op">=</span> <span class="st">"original_count_index"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">sum_cv</span>, <span class="st">"output/sum_cv.rds"</span><span class="op">)</span> <span class="co"># overall summary in grouped data frame</span></span>
<span></span>
<span><span class="va">cv_dif</span> <span class="op">&lt;-</span> <span class="va">wide_cv</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">.</span>,<span class="va">orig_data</span>,</span>
<span>             by <span class="op">=</span> <span class="st">"original_count_index"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">#dropping the single points that were never in the testing dataset</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">log_lik_first_diff</span> <span class="op">-</span> <span class="va">log_lik_gamye</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">cv_dif</span>,<span class="st">"output/cv_dif.rds"</span><span class="op">)</span> <span class="co"># summary of point-wise difference in log_lik between models</span></span></code></pre></div>
<p>Now that we have combined the results for all of the predicted counts
from across the k-folds and the two models, we can summarize these
values. Again, because of the scaling of log probabilities that smaller
absolute values (values closer to 0) indicate a better fitting
model.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sum_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/sum_cv.rds"</span><span class="op">)</span></span>
<span><span class="va">cv_comp</span> <span class="op">&lt;-</span> <span class="va">sum_cv</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html" class="external-link">drop_na</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="co">#drops the rows for counts that were never in testing datasets</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>sum_log_lik <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span>, <span class="co"># total sum of log likelihoods</span></span>
<span>            mean_log_lik <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span>, <span class="co"># mean of point-level values</span></span>
<span>            se_log_lik <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mean</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># SE of point-level values</span></span>
<span></span>
<span><span class="va">cv_comp</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 4</span></span>
<span><span class="co">#&gt;   model      sum_log_lik mean_log_lik se_log_lik</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;            &lt;dbl&gt;        &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 first_diff     -11251.        -2.66     0.0663</span></span>
<span><span class="co">#&gt; 2 gamye          -10115.        -2.39     0.0559</span></span></code></pre></div>
<p>Interestingly, the cross-validation results suggest that the gamye
model performs better than the first_diff model: The opposite finding of
the approximation. Model comparison is not a simple thing, especially
for complex models with complex data.</p>
<p>We can explore the point-level relative support for each of the two
models to better understand what aspects of the data are better
predicted by each model. For example, we can plot the difference in log
likelihood values against the value of the observed counts. Here, we can
see that the high counts, particularly those in the earlier years,
appear to be better predicted by the gamye model than the
first-difference model.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cv_dif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/cv_dif.rds"</span><span class="op">)</span></span>
<span><span class="va">cv_dif_sum</span> <span class="op">&lt;-</span> <span class="va">cv_dif</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span>,</span>
<span>            se_diff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">diff</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            z <span class="op">=</span> <span class="va">mean_diff</span><span class="op">/</span><span class="va">se_diff</span><span class="op">)</span></span>
<span><span class="va">cv_dif_sum</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 3</span></span>
<span><span class="co">#&gt;   mean_diff se_diff     z</span></span>
<span><span class="co">#&gt;       &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1    -0.269  0.0186 -14.4</span></span>
<span></span>
<span><span class="co"># explore the differences by count value</span></span>
<span><span class="va">dif_by_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cv_dif</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">count</span><span class="op">+</span><span class="fl">1</span>,y <span class="op">=</span> <span class="va">diff</span>,</span>
<span>                 colour <span class="op">=</span> <span class="va">year</span><span class="op">)</span>,</span>
<span>             alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_colour_viridis_c</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="co">#scale_x_continuous(trans = "log10")+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dif_by_count</span></span></code></pre></div>
<p><img src="figures/advanced_unnamed-chunk-32-1.png" alt="Cross validation differences"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Brandon P.M. Edwards, Adam C. Smith, Steffi LaZerte.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
