<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Get Started • bbsBayes2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Get Started">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bbsBayes2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/bbsBayes2.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbsBayes/bbsBayes2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Get Started</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bbsBayes/bbsBayes2/blob/v1.1.2.1/vignettes/articles/bbsBayes2.Rmd" class="external-link"><code>vignettes/articles/bbsBayes2.Rmd</code></a></small>
      <div class="d-none name"><code>bbsBayes2.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbsBayes/bbsBayes2" class="external-link">bbsBayes2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="welcome">Welcome!<a class="anchor" aria-label="anchor" href="#welcome"></a>
</h2>
<p>bbsBayes2 is the successor to <a href="https://github.com/bbsBayes/bbsBayes" class="external-link">bbsBayes</a>, with a major
shift in functionality. The MCMC backend is now <em>Stan</em> instead of
<em>JAGS</em>, the workflow has been streamlined, the syntax has
changed, and there are new functions. This vignette should help you get
started with the package, and there are three others that should help
explain some of the new features, choices, and more advanced uses:</p>
<ul>
<li><p><a href="./stratification.html">Stratification vignette</a> The
stratification vignette explains the built-in options for spatial
stratifications as well as the workflow required to apply a custom
stratification.</p></li>
<li><p><a href="./models.html">Models vignette</a> The models vignette
explains the four built-in models that differ in the way the temporal
components are structured, and it also covers the built-in options for
error distributions and the differences among the model variants (e.g.,
<code>model_variant = "spatial"</code>).</p></li>
<li><p><a href="./advanced.html">Advanced vignette</a> The advanced
vignette is helpful for users wanting to take the bbsBayes2
functionality further, including alternate calculations of population
trend, customizing the Stan models, adding covariates, and even some
experimental functions that allow for k-fold cross-validations and
approximate leave-one-out calculations to compare fit and predictive
accuracy among models.</p></li>
</ul>
<p>First we’ll make sure we have the right software installed, we’ll
fetch the BBS survey data, and then we’ll run through some example
workflows.</p>
<div class="section level3">
<h3 id="install-bbsbayes2">Install <a href="https://github.com/bbsBayes/bbsBayes2" class="external-link">bbsbayes2</a><a class="anchor" aria-label="anchor" href="#install-bbsbayes2"></a>
</h3>
<p>If you haven’t already, install bbsBayes2 from the R-Universe.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"bbsBayes2"</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>bbsbayes <span class="op">=</span> <span class="st">"https://bbsbayes.r-universe.dev"</span>,</span>
<span>                                        CRAN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"repos"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that due to non-CRAN dependencies, bbsBayes2 is not available on
CRAN and must be installed from GitHub or the R-Universe.</p>
</div>
<div class="section level3">
<h3 id="install-cmdstanr">Install <a href="https://mc-stan.org/cmdstanr/" class="external-link">cmdstanr</a><a class="anchor" aria-label="anchor" href="#install-cmdstanr"></a>
</h3>
<p>Because bbsBayes2 uses Stan to run the Bayesian models, we need to
make sure we have cmdstanr and cmdstan both installed.</p>
<p>Run this in a fresh R session.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"cmdstanr"</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"https://mc-stan.org/r-packages/"</span>,</span>
<span>                                       <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"repos"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we should be able to use cmdstanr to install cmdstan</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">install_cmdstan</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Let’s check that everything went as planned, and tell cmdstanr to fix
any issues.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cmdstanr</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/cmdstanr/reference/install_cmdstan.html" class="external-link">check_cmdstan_toolchain</a></span><span class="op">(</span>fix <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; The C++ toolchain required for CmdStan is setup properly!</span></span></code></pre></div>
<blockquote>
<p>Problems? Check out cmdstanr’s vignette on <a href="https://mc-stan.org/cmdstanr/articles/cmdstanr.html" class="external-link">Getting
Started</a></p>
</blockquote>
<div class="section level4">
<h4 id="special-note-for-windows-users">Special note for Windows users<a class="anchor" aria-label="anchor" href="#special-note-for-windows-users"></a>
</h4>
<p>We strongly recommend that you install Linux on your Windows machine
and take advantage of <code>cmdstanr</code> functions that run
<code>Stan</code> models in Linux. This will likely cut the MCMC
run-times by 30-50% for the <code>bbsBayes2</code> models. Installing <a href="https://learn.microsoft.com/en-us/windows/wsl/install" class="external-link">Windows
Subsystem for Linux (WSL)</a> is a small hassle, but only needs to be
done once. Follow the directions at the above link.</p>
<p>Once the WSL installation is complete, re-install
<code>cmdstan</code> using
<code>cmdstanr::install_cmdstan(overwrite = TRUE, wsl = TRUE)</code>.
Now, everytime you run a model using <code>cmdstan</code> (and therefore
anytime you run a model using <code>bbsBayes2</code>), it will use the
Linux installation to run Stan. It’s seamless and you’ll be very
thankful you did it once it’s done.</p>
</div>
</div>
<div class="section level3">
<h3 id="download-bbs-data">Download BBS data<a class="anchor" aria-label="anchor" href="#download-bbs-data"></a>
</h3>
<p>Now we’ll fetch the BBS data using the <code><a href="../reference/fetch_bbs_data.html">fetch_bbs_data()</a></code>
function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbsBayes/bbsBayes2" class="external-link">bbsBayes2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/fetch_bbs_data.html">fetch_bbs_data</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#</span></span></code></pre></div>
<p>This will save the data to a package-specific directory on your
computer. You must agree to the terms and conditions of the data usage
before the download will run (type <code>yes</code> at the prompt). The
message also includes the key metadata for the dataset, including the
citation, acknowledgements, and the release-version (below). You only
need run this function once for each annual update of the BBS database
(these updates usually occur in the summer, approximately 1-year
following the data collection).</p>
<blockquote>
<p>Note: Most bbsBayes2 functionality can be explored
<strong>without</strong> downloading BBS data by using the included
sample data. Specify <code>sample_data = TRUE</code> in the first
<code><a href="../reference/stratify.html">stratify()</a></code> step (see the next section).</p>
</blockquote>
<p>There are two types of BBS data that can be downloaded, and annual
release-versions:</p>
<ul>
<li>Two levels <code>state</code> and <code>stop</code> (only
<code>state</code> works with bbsBayes2 models, the <code>stop</code>
option is provided to facilitate custom projects and models)</li>
<li>Annual releases <code>2020</code>, <code>2022</code>,
<code>2023</code>, and ‘2024’ more options will be added as annual
releases occur).</li>
</ul>
<p>The defaults (level <code>state</code> and the most recent release -
<code>2024</code>) is almost certainly what you are looking for, Unless
you have a specific reason to need a different version. The most recent
release will include all of the data included in earlier releases.
However you can download all releases and specify which one you wish to
use in the <code><a href="../reference/stratify.html">stratify()</a></code> step.</p>
<div class="section level4">
<h4 id="a-note-about-bbs-release-names">A note about BBS release names:<a class="anchor" aria-label="anchor" href="#a-note-about-bbs-release-names"></a>
</h4>
<p>The releases are named for the year in which the annual dataset was
released after going through QA-QC. So the <code>2022</code> release
contains all surveys conducted up to and including the 2021 field
season. There is no <code>release = 2021</code>, because the BBS was
cancelled during the COVID lockdowns of spring 2020 so no data were
collected and there was no updated data to release the following
year.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fetch_bbs_data.html">fetch_bbs_data</a></span><span class="op">(</span><span class="op">)</span>                  <span class="co"># Default - most recent release</span></span>
<span><span class="fu"><a href="../reference/fetch_bbs_data.html">fetch_bbs_data</a></span><span class="op">(</span>release <span class="op">=</span> <span class="st">"2020"</span><span class="op">)</span>  <span class="co"># Specify a different release</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="workflow-overview">Workflow overview<a class="anchor" aria-label="anchor" href="#workflow-overview"></a>
</h3>
<p>We can visualize the bbsBayes2 workflow with this flow chart of
functions.</p>
<p>The functions are colour coded by category:</p>
<ul>
<li>BBS Data - Blue</li>
<li>Data Prep - Pink</li>
<li>Modelling - Green</li>
<li>Exploring model trends and indices - Purple</li>
<li>General helper functions - Orange</li>
</ul>
<p>Functions which are connected by a <strong>solid, black</strong>
arrow, indicate that the output of the first function is required as
input to the second. For example, the output of <code><a href="../reference/stratify.html">stratify()</a></code>
is required input for <code><a href="../reference/prepare_data.html">prepare_data()</a></code>.</p>
<p>Functions which are connected by a <strong>solid, grey</strong>
arrow, indicate that the output of the first function is
<em>optional</em> input to the second. For example, the output of
<code><a href="../reference/generate_trends.html">generate_trends()</a></code> is an option input for
<code><a href="../reference/plot_geofacet.html">plot_geofacet()</a></code>.</p>
<p>Functions which are connected by a <strong>dotted</strong> arrow
indicate that the first function can be used to create input for the
second, but not necessarily directly. For example,
<code><a href="../reference/fetch_bbs_data.html">fetch_bbs_data()</a></code> downloads BBS data which is used by
<code><a href="../reference/stratify.html">stratify()</a></code>, but it isn’t an input. Alternatively,
<code><a href="../reference/load_map.html">load_map()</a></code> can load a spatial data file for a specific
stratification which can be modified by the user and then used as input
to <code><a href="../reference/prepare_spatial.html">prepare_spatial()</a></code> or
<code><a href="../reference/generate_indices.html">generate_indices()</a></code>.</p>
<p>See the <a href="../reference">Function Reference</a> for more
details on how to use a particular function.</p>
<div class="float">
<img src="figures%2Fworkflow_diagram.png" alt="Workflow diagram demonstrating the steps, ordering, and dependencies of the key functions within the bbsBayes2 package"><div class="figcaption">Workflow diagram demonstrating the steps,
ordering, and dependencies of the key functions within the bbsBayes2
package</div>
</div>
</div>
<div class="section level3">
<h3 id="workflow-to-fit-models">Workflow to fit models<a class="anchor" aria-label="anchor" href="#workflow-to-fit-models"></a>
</h3>
<blockquote>
<p>Note: If you would prefer to skip the model-fitting process for now,
skip down to <a href="#explore_output">Workflow to explore the model
outputs</a>.</p>
</blockquote>
<p>Now that you have cmdstanr installed and the BBS data downloaded,
we’ll walk through a general workflow for modelling species trends with
bbsBayes2.</p>
<div class="section level4">
<h4 id="stratify-the-data">Stratify the data<a class="anchor" aria-label="anchor" href="#stratify-the-data"></a>
</h4>
<p>The first step in any bbsBayes2 analysis is to stratify the data. In
this step we choose a stratification type as well as a species to
explore.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_usgs"</span>, species <span class="op">=</span> <span class="st">"Scissor-tailed Flycatcher"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using 'bbs_usgs' (standard) stratification</span></span>
<span><span class="co">#&gt; Loading BBS data...</span></span>
<span><span class="co">#&gt; Filtering to species Scissor-tailed Flycatcher (4430)</span></span>
<span><span class="co">#&gt; Stratifying data...</span></span>
<span><span class="co">#&gt;   Renaming routes...</span></span></code></pre></div>
<p>We can also play around with the included sample data (Pacific
Wrens)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_cws"</span>, sample_data <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># Only Pacific Wren</span></span>
<span><span class="co">#&gt; Using 'bbs_cws' (standard) stratification</span></span>
<span><span class="co">#&gt; Using sample BBS data...</span></span>
<span><span class="co">#&gt; Using species Pacific Wren (sample data)</span></span>
<span><span class="co">#&gt; Filtering to species Pacific Wren (7221)</span></span>
<span><span class="co">#&gt; Stratifying data...</span></span>
<span><span class="co">#&gt;   Combining BCR 7 and NS and PEI...</span></span>
<span><span class="co">#&gt;   Renaming routes...</span></span></code></pre></div>
<p>Stratifications included in bbsBayes2 are bbs_usgs, bbs_cws, bcr,
latlong, prov_state. See the article on <a href="articles/stratification">stratifications</a> for more details and
examples.</p>
<div class="section level5">
<h5 id="species-names-in-bbsbayes2">Species names in bbsBayes2<a class="anchor" aria-label="anchor" href="#species-names-in-bbsbayes2"></a>
</h5>
<p>Let’s first take a brief step out of the workflow to explain
important information about species names in bbsBayes2.</p>
<p>All of the models in the package are species-specific. So the species
is a fundamental aspect of any analysis. The
<code><a href="../reference/search_species.html">search_species()</a></code> function allows the user to search up the
species names in the BBS database, using text from the English, Spanish,
French, or Latin names. The English names for each species will be
retained in the metadata at every step of the workflow.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/search_species.html">search_species</a></span><span class="op">(</span><span class="st">"Geai bleu"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 8</span></span>
<span><span class="co">#&gt;     aou english  french    order family genus species unid_combined</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;lgl&gt;        </span></span>
<span><span class="co">#&gt; 1  4770 Blue Jay Geai bleu Pass… Corvi… Cyan… crista… TRUE</span></span>
<span><span class="fu"><a href="../reference/search_species.html">search_species</a></span><span class="op">(</span><span class="st">"Cyanocitta"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 8</span></span>
<span><span class="co">#&gt;     aou english     french order family genus species unid_combined</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;lgl&gt;        </span></span>
<span><span class="co">#&gt; 1  4780 Steller's … Geai … Pass… Corvi… Cyan… stelle… TRUE         </span></span>
<span><span class="co">#&gt; 2  4770 Blue Jay    Geai … Pass… Corvi… Cyan… crista… TRUE</span></span>
<span><span class="fu"><a href="../reference/search_species.html">search_species</a></span><span class="op">(</span><span class="st">"Corvidae"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 20 × 8</span></span>
<span><span class="co">#&gt;      aou english    french order family genus species unid_combined</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;lgl&gt;        </span></span>
<span><span class="co">#&gt;  1  4840 Canada Jay Mésan… Pass… Corvi… Peri… canade… TRUE         </span></span>
<span><span class="co">#&gt;  2  4830 Green Jay  Geai … Pass… Corvi… Cyan… yncas   TRUE         </span></span>
<span><span class="co">#&gt;  3  4920 Pinyon Jay Geai … Pass… Corvi… Gymn… cyanoc… TRUE         </span></span>
<span><span class="co">#&gt;  4  4780 Steller's… Geai … Pass… Corvi… Cyan… stelle… TRUE         </span></span>
<span><span class="co">#&gt;  5  4770 Blue Jay   Geai … Pass… Corvi… Cyan… crista… TRUE         </span></span>
<span><span class="co">#&gt;  6  4790 Florida S… Geai … Pass… Corvi… Aphe… coerul… TRUE         </span></span>
<span><span class="co">#&gt;  7  4811 Island Sc… Geai … Pass… Corvi… Aphe… insula… TRUE         </span></span>
<span><span class="co">#&gt;  8  4812 Californi… Geai … Pass… Corvi… Aphe… califo… TRUE         </span></span>
<span><span class="co">#&gt;  9  4813 Woodhouse… Geai … Pass… Corvi… Aphe… woodho… TRUE         </span></span>
<span><span class="co">#&gt; 10  4810 unid. Cal… unid … Pass… Corvi… Aphe… califo… TRUE         </span></span>
<span><span class="co">#&gt; 11  4820 Mexican J… Geai … Pass… Corvi… Aphe… wollwe… TRUE         </span></span>
<span><span class="co">#&gt; 12  4910 Clark's N… Casse… Pass… Corvi… Nuci… columb… TRUE         </span></span>
<span><span class="co">#&gt; 13  4750 Black-bil… Pie d… Pass… Corvi… Pica  hudson… TRUE         </span></span>
<span><span class="co">#&gt; 14  4760 Yellow-bi… Pie à… Pass… Corvi… Pica  nuttal… TRUE         </span></span>
<span><span class="co">#&gt; 15  4880 American … Corne… Pass… Corvi… Corv… brachy… TRUE         </span></span>
<span><span class="co">#&gt; 16  4900 Fish Crow  Corne… Pass… Corvi… Corv… ossifr… TRUE         </span></span>
<span><span class="co">#&gt; 17  4881 unid. Ame… unid … Pass… Corvi… Corv… brachy… TRUE         </span></span>
<span><span class="co">#&gt; 18  4870 Chihuahua… Corbe… Pass… Corvi… Corv… crypto… TRUE         </span></span>
<span><span class="co">#&gt; 19  4860 Common Ra… Grand… Pass… Corvi… Corv… corax   TRUE         </span></span>
<span><span class="co">#&gt; 20  4865 unid. Chi… unid … Pass… Corvi… Corv… crypto… TRUE</span></span></code></pre></div>
<div class="section level6">
<h6 id="species-groupings">Species groupings<a class="anchor" aria-label="anchor" href="#species-groupings"></a>
</h6>
<p>There are some taxonomic groupings of species-units in the BBS
database that bbsBayes2 by default also groups into combined species
forms. These represent groupings that make sense based on changes in
taxonomy or potentially inconsistent distinctions among observers,
routes, regions, or time.</p>
<ul>
<li>There are groupings that represent species considered distinct in
the early portion of the BBS history that have been lumped into a single
species at some point since then. For example, the Northern Flicker
observations exist in the BBS database separately as Red-shafted Flicker
(4130), Yellow-shafted Flicker (4120), unidentified Red/Yellow-shafted
Flicker (4123) or hybrid Red x Yellow-shafted Flicker (4125). To provide
an appropriate dataset to represent population trends of Northern
Flicker, bbsBayes2 by default sums all of these observations into a new
<em>species</em> called Northern Flicker (all forms), which replaces the
(4123) unidentified category in the species database. The remaining
original separate forms (Red, Yellow, and hybrid) are retained.</li>
<li>Similar combined <em>species</em> are created for taxonomic splits
that have occurred since the start of the BBS, such as Clark’s and
Western Grebe, which are retained as their own separate species, but are
also combined into Western Grebe (Clark’s/Western) (12). You can access
a complete list of these combined <em>species</em> groups and the sub
groups that make them up.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bbsBayes2</span><span class="fu">::</span><span class="va"><a href="../reference/species_forms.html">species_forms</a></span></span>
<span><span class="co">#&gt;    aou_unid                               english_original</span></span>
<span><span class="co">#&gt; 1      2973              unid. Dusky Grouse / Sooty Grouse</span></span>
<span><span class="co">#&gt; 2      5677                   (unid. race) Dark-eyed Junco</span></span>
<span><span class="co">#&gt; 3      4123    (unid. Red/Yellow Shafted) Northern Flicker</span></span>
<span><span class="co">#&gt; 4      5077      unid. Bullock's Oriole / Baltimore Oriole</span></span>
<span><span class="co">#&gt; 5      3370                                Red-tailed Hawk</span></span>
<span><span class="co">#&gt; 6      4022                                unid. sapsucker</span></span>
<span><span class="co">#&gt; 7      1690                                     Snow Goose</span></span>
<span><span class="co">#&gt; 8      6295       unid. Cassin's Vireo / Blue-headed Vireo</span></span>
<span><span class="co">#&gt; 9      4665     unid. Alder Flycatcher / Willow Flycatcher</span></span>
<span><span class="co">#&gt; 10     4642   unid. Cordilleran / Pacific-slope Flycatcher</span></span>
<span><span class="co">#&gt; 11       12            unid. Western Grebe / Clark's Grebe</span></span>
<span><span class="co">#&gt; 12     6556 (unid. Myrtle/Audubon's) Yellow-rumped Warbler</span></span>
<span><span class="co">#&gt; 13     5275           unid. Common Redpoll / Hoary Redpoll</span></span>
<span><span class="co">#&gt; 14     5012                               unid. Meadowlark</span></span>
<span><span class="co">#&gt;                                                   english_combined</span></span>
<span><span class="co">#&gt; 1                                        Blue Grouse (Dusky/Sooty)</span></span>
<span><span class="co">#&gt; 2                                      Dark-eyed Junco (all forms)</span></span>
<span><span class="co">#&gt; 3                                     Northern Flicker (all forms)</span></span>
<span><span class="co">#&gt; 4                            Northern Oriole (Bullock's/Baltimore)</span></span>
<span><span class="co">#&gt; 5                                      Red-tailed Hawk (all forms)</span></span>
<span><span class="co">#&gt; 6  Sapsuckers (Yellow-bellied/Red-naped/Red-breasted/Williamson's)</span></span>
<span><span class="co">#&gt; 7                                           Snow Goose (all forms)</span></span>
<span><span class="co">#&gt; 8                            Solitary Vireo (Blue-headed/Cassin's)</span></span>
<span><span class="co">#&gt; 9                               Traill's Flycatcher (Alder/Willow)</span></span>
<span><span class="co">#&gt; 10                  Western Flycatcher (Cordilleran/Pacific-slope)</span></span>
<span><span class="co">#&gt; 11                                 Western Grebe (Clark's/Western)</span></span>
<span><span class="co">#&gt; 12                               Yellow-rumped Warbler (all forms)</span></span>
<span><span class="co">#&gt; 13                                          Redpoll (Common/Hoary)</span></span>
<span><span class="co">#&gt; 14                         Meadowlark (Eastern/Western/Chihuahuan)</span></span>
<span><span class="co">#&gt;                                                french_combined</span></span>
<span><span class="co">#&gt; 1                            Tétras sombre (sombre/fuligineux)</span></span>
<span><span class="co">#&gt; 2                            Junco ardoisé (toutes les formes)</span></span>
<span><span class="co">#&gt; 3                           Pic flamboyant (toutes les formes)</span></span>
<span><span class="co">#&gt; 4                     Oriole du Nord (de Bullock/de Baltimore)</span></span>
<span><span class="co">#&gt; 5                      Buse à queue rousse (toutes les formes)</span></span>
<span><span class="co">#&gt; 6  Pics buveur de sève (maculé/à nuque rouge/à poitrine rouge)</span></span>
<span><span class="co">#&gt; 7                           Oie des neiges (toutes les formes)</span></span>
<span><span class="co">#&gt; 8                  Viréo à tête bleue (à tête bleue/de Cassin)</span></span>
<span><span class="co">#&gt; 9               Moucherolle de Traill (des aulnes/ des saules)</span></span>
<span><span class="co">#&gt; 10                     Moucherolle côtier (des ravins/ côtier)</span></span>
<span><span class="co">#&gt; 11                      Grèbe élégant (à face blanche/élégant)</span></span>
<span><span class="co">#&gt; 12               Paruline à croupion jaune (toutes les formes)</span></span>
<span><span class="co">#&gt; 13                                 Sizerin (flammé/blanchâtre)</span></span>
<span><span class="co">#&gt; 14                               Sturnelle (prés/Ouest/Lilian)</span></span>
<span><span class="co">#&gt;                          aou_id</span></span>
<span><span class="co">#&gt; 1                    2970, 2971</span></span>
<span><span class="co">#&gt; 2  5671, 5670, 5680, 5660, 5690</span></span>
<span><span class="co">#&gt; 3              4125, 4120, 4130</span></span>
<span><span class="co">#&gt; 4              5080, 5070, 5078</span></span>
<span><span class="co">#&gt; 5                          3380</span></span>
<span><span class="co">#&gt; 6        4020, 4021, 4031, 4032</span></span>
<span><span class="co">#&gt; 7                          1691</span></span>
<span><span class="co">#&gt; 8              6292, 6291, 6290</span></span>
<span><span class="co">#&gt; 9                    4661, 4660</span></span>
<span><span class="co">#&gt; 10                   4641, 4640</span></span>
<span><span class="co">#&gt; 11                       10, 11</span></span>
<span><span class="co">#&gt; 12                   6550, 6560</span></span>
<span><span class="co">#&gt; 13                   5270, 5280</span></span>
<span><span class="co">#&gt; 14             5009, 5010, 5011</span></span></code></pre></div>
<ul>
<li>These splits that have occurred since the start of the BBS require
some extra care when considering what years to include in any model fit.
For example, if fitting a trend model to the data for Clark’s Grebe, it
would not make sense to include all years back to 1966. Prior to 1985,
Clark’s Grebe was not a distinct species and so observers would not have
recorded observations for this <em>species</em> in the same was as they
would have after 1985. The <code><a href="../reference/prepare_data.html">prepare_data()</a></code> function will
generate warnings if the user selects a species and time-period where
these species identification-issues may be important. Related concerns
with time-span may apply to species that have expanded their range into
the surveyed area of the BBS since the beginning of surveys. A list of
the species where these time-span concerns may be most relevant can be
found by calling the built-in data table.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">bbsBayes2</span><span class="fu">::</span><span class="va"><a href="../reference/species_notes.html">species_notes</a></span></span>
<span><span class="co">#&gt;                  english                  french   aou</span></span>
<span><span class="co">#&gt; 1       Alder Flycatcher  Moucherolle des aulnes  4661</span></span>
<span><span class="co">#&gt; 2      Willow Flycatcher  Moucherolle des saules  4660</span></span>
<span><span class="co">#&gt; 3          Clark's Grebe    Grèbe à face blanche    11</span></span>
<span><span class="co">#&gt; 4          Western Grebe           Grèbe élégant    10</span></span>
<span><span class="co">#&gt; 5 Eurasian Collared-Dove      Tourterelle turque 22860</span></span>
<span><span class="co">#&gt; 6           Cave Swallow Hirondelle à front brun  6121</span></span>
<span><span class="co">#&gt;   minimum_year</span></span>
<span><span class="co">#&gt; 1         1978</span></span>
<span><span class="co">#&gt; 2         1978</span></span>
<span><span class="co">#&gt; 3         1990</span></span>
<span><span class="co">#&gt; 4         1990</span></span>
<span><span class="co">#&gt; 5         1990</span></span>
<span><span class="co">#&gt; 6         1985</span></span>
<span><span class="co">#&gt;                                                                                                                                                                                     warning</span></span>
<span><span class="co">#&gt; 1 Alder and Willow Flycatcher were considered a single species until 1973. It is likely that they are not accurately separated by BBS observers until at least some years after that split.</span></span>
<span><span class="co">#&gt; 2 Alder and Willow Flycatcher were considered a single species until 1973. It is likely that they are not accurately separated by BBS observers until at least some years after that split.</span></span>
<span><span class="co">#&gt; 3   Clark's and Western Grebe were considered a single species until 1985. It is likely that they are not accurately separated by BBS observers until at least some years after that split.</span></span>
<span><span class="co">#&gt; 4   Clark's and Western Grebe were considered a single species until 1985. It is likely that they are not accurately separated by BBS observers until at least some years after that split.</span></span>
<span><span class="co">#&gt; 5                                     Eurasian Collared Dove was introduced into North America in the 1980s. 1990 is the first year that the species was observed on at least 3 BBS routes.</span></span>
<span><span class="co">#&gt; 6                                                      Cave Swallows were relatively rare in the areas surveyed by BBS before 1980. There are only two observations during BBS before 1980.</span></span></code></pre></div>
<p>If you’re looking for a complete list of all species in the BBS
database.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all_species_bbs_database</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_bbs_data.html">load_bbs_data</a></span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">species</span></span></code></pre></div>
<blockquote>
<p>Note: Because models can take hours to days to run, if you’re
exploring the package functionality, we recommend using species with
relatively small ranges (i.e., relatively few data) such as the Hepatic
Tanager, Pacific Wren, or Scissor-tailed Flycatcher.</p>
</blockquote>
</div>
</div>
</div>
<div class="section level4">
<h4 id="prepare-the-data">Prepare the data<a class="anchor" aria-label="anchor" href="#prepare-the-data"></a>
</h4>
<p>Once we have stratified the data, we can now prepare it for use in a
model. In this step data will be filtered to omit routes with too few
samples, etc. See <code><a href="../reference/prepare_data.html">prepare_data()</a></code> for more details on how
you can customize this step.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="prepare-the-model">Prepare the model<a class="anchor" aria-label="anchor" href="#prepare-the-model"></a>
</h4>
<p>Next we will prepare the model parameters and initialization values.
See <code><a href="../reference/prepare_model.html">prepare_model()</a></code> for more details on how you can
customize this step.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">p</span>, model <span class="op">=</span> <span class="st">"first_diff"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="run-model">Run model<a class="anchor" aria-label="anchor" href="#run-model"></a>
</h4>
<p>Now we can run the model.</p>
<p>The default <code>iter_sampling</code> and <code>iter_warmup</code>
are 1000 and the default <code>chains</code> is 4. In the interest of
speed for this example, we are using much lower values, but note that
this almost certainly will result in problems with our model.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">md</span>, iter_sampling <span class="op">=</span> <span class="fl">100</span>, iter_warmup <span class="op">=</span> <span class="fl">500</span>, chains <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="additional-steps-for-spatial-models">Additional steps for spatial models<a class="anchor" aria-label="anchor" href="#additional-steps-for-spatial-models"></a>
</h4>
<p>For spatial models there are two additional steps. You stratify and
prepare the data as in the previous example, but you also prepare the
map and the spatial data. An example is below.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span>by <span class="op">=</span> <span class="st">"bbs_usgs"</span>, species<span class="op">=</span><span class="st">"Scissor-tailed Flycatcher"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using 'bbs_usgs' (standard) stratification</span></span>
<span><span class="co">#&gt; Loading BBS data...</span></span>
<span><span class="co">#&gt; Filtering to species Scissor-tailed Flycatcher (4430)</span></span>
<span><span class="co">#&gt; Stratifying data...</span></span>
<span><span class="co">#&gt;   Renaming routes...</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<p>And now the additional steps…</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load a map</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span>stratify_by <span class="op">=</span> <span class="st">"bbs_usgs"</span><span class="op">)</span></span>
<span><span class="co"># Prepare the spatial data</span></span>
<span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_spatial.html">prepare_spatial</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">map</span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparing spatial data...</span></span>
<span><span class="co">#&gt; Identifying neighbours (non-Voronoi method)...</span></span>
<span><span class="co">#&gt; Formating neighbourhood matrices...</span></span>
<span><span class="co">#&gt; Plotting neighbourhood matrices...</span></span></code></pre></div>
<p>Then the remaining steps are the same but we use
<code>model_variant = "spatial"</code> in
<code><a href="../reference/prepare_model.html">prepare_model()</a></code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Then prepare the model with the spatial output</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span><span class="va">sp</span>, model <span class="op">=</span> <span class="st">"gamye"</span>, model_variant <span class="op">=</span> <span class="st">"spatial"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Then run the model as before</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Optionally, save the model output as an .rds file</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">"output/4430_gamye_spatial.rds"</span><span class="op">)</span></span></code></pre></div>
<p>The spatial aspects of the spatial model variants use an intrinsic
Conditional Autoregressive structure (iCAR) to share information among
neighbouring strata on the population abundance and trend parameter (<a href="https://doi.org/10.1007/BF00116466" class="external-link">Besag et al. 1991</a>, <a href="http://doi.wiley.com/10.1002/ecm.1283" class="external-link">ver Hoef et al. 2018</a>,
<a href="https://doi.org/10.1016/j.sste.2019.100301" class="external-link">Morris et
al. 2019</a>). For more information about the bbsBayes2 models and the
spatial models see the <a href="./models.html">models vignette</a> and
<a href="https://doi.org/10.1093/ornithapp/duad056" class="external-link">Smith et al.,
2024</a>.</p>
<p>The prepared spatial data object includes a map of the spatial
neighbourhood relationships for a given species and stratification.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sp</span><span class="op">$</span><span class="va">spatial_data</span><span class="op">$</span><span class="va">map</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-23-1.png" alt="Map showing the strata and neighbourhood relationships among them for Scissor-tailed Flycatcher"></p>
</div>
</div>
<div class="section level3">
<h3 id="explore_output">Workflow to explore the model outputs<a class="anchor" aria-label="anchor" href="#explore_output"></a>
</h3>
<p>If you would prefer to skip the model fitting steps for now, you can
<a href="https://drive.google.com/file/d/14SYabzAj_3IGmbBB-y0NZfBngKytiR0x/view?usp=sharing" class="external-link">download
a fitted model</a> object (the output of the code below) and test out
the remaining package features.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbsBayes/bbsBayes2" class="external-link">bbsBayes2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">species</span> <span class="op">&lt;-</span> <span class="st">"Scissor-tailed Flycatcher"</span></span>
<span></span>
<span><span class="co"># extract the unique numerical identifier for this species in the BBS database</span></span>
<span><span class="va">species_number</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/search_species.html">search_species</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">aou</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="st">"gamye"</span></span>
<span><span class="va">var</span> <span class="op">&lt;-</span> <span class="st">"spatial"</span></span>
<span></span>
<span><span class="va">out_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"output/"</span>,</span>
<span>                      <span class="va">species_number</span>,</span>
<span>                      <span class="st">"_"</span>,</span>
<span>                      <span class="va">mod</span>,</span>
<span>                      <span class="st">"_"</span>,</span>
<span>                      <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stratify.html">stratify</a></span><span class="op">(</span><span class="st">"bbs_usgs"</span>,</span>
<span>              species <span class="op">=</span> <span class="va">species</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/prepare_spatial.html">prepare_spatial</a></span><span class="op">(</span><span class="va">s</span>, strata_map <span class="op">=</span> <span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span><span class="st">"bbs_usgs"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/prepare_model.html">prepare_model</a></span><span class="op">(</span>model <span class="op">=</span> <span class="va">mod</span>, model_variant <span class="op">=</span> <span class="va">var</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">d</span>,</span>
<span>    output_basename <span class="op">=</span> <span class="va">out_name</span>,</span>
<span>    output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># by default saves the model output using output_basename</span></span></code></pre></div>
<p>The outputs of the collection of functions required to fit a model
are cumulative: each one retains the metadata from the previous step. As
a result, the saved object from the <code><a href="../reference/run_model.html">run_model()</a></code> function is
a large list that includes the <code>cmdstanr</code> posterior samples
object from the model fitting process, as well as all of the data and
metadata necessary to understand and replicate the choices made to fit
the model.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/4430_gamye_spatial.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "model_fit"   "model_data"  "meta_data"   "meta_strata"</span></span>
<span><span class="co">#&gt; [5] "raw_data"</span></span></code></pre></div>
<div class="section level4">
<h4 id="convergence-and-parameter-summaries">Convergence and parameter summaries<a class="anchor" aria-label="anchor" href="#convergence-and-parameter-summaries"></a>
</h4>
<p>First, we will investigate the model convergence and the parameter
estimates of the model. There are two key helper functions in
<code>bbsBayes2</code> that provide information on model convergence:
<code><a href="../reference/get_convergence.html">get_convergence()</a></code> calculates convergence diagnostics and
<code><a href="../reference/get_summary.html">get_summary()</a></code> calculates the convergence diagnostics as
well as summary statistics (mean, median, credible intervals) for all
parameters in a fitted model.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convergence diagnostics for all parameters</span></span>
<span><span class="va">converge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_convergence.html">get_convergence</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convergence diagnostics for all smoothed annual indices</span></span>
<span><span class="va">converge_n_smooth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_convergence.html">get_convergence</a></span><span class="op">(</span><span class="va">m</span>, variables <span class="op">=</span> <span class="st">"n_smooth"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">rhat</span><span class="op">)</span></span>
<span><span class="va">converge_n_smooth</span></span>
<span><span class="co">#&gt; # A tibble: 1,425 × 5</span></span>
<span><span class="co">#&gt;    variable_type variable         rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;         &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 n_smooth      n_smooth[21,25]  1.00    5881.    2893.</span></span>
<span><span class="co">#&gt;  2 n_smooth      n_smooth[20,16]  1.00    4369.    3568.</span></span>
<span><span class="co">#&gt;  3 n_smooth      n_smooth[20,15]  1.00    4363.    3713.</span></span>
<span><span class="co">#&gt;  4 n_smooth      n_smooth[18,27]  1.00    4850.    3204.</span></span>
<span><span class="co">#&gt;  5 n_smooth      n_smooth[24,33]  1.00    5138.    3663.</span></span>
<span><span class="co">#&gt;  6 n_smooth      n_smooth[18,29]  1.00    4999.    3353.</span></span>
<span><span class="co">#&gt;  7 n_smooth      n_smooth[16,51]  1.00    4498.    3746.</span></span>
<span><span class="co">#&gt;  8 n_smooth      n_smooth[18,28]  1.00    5024.    3182.</span></span>
<span><span class="co">#&gt;  9 n_smooth      n_smooth[16,50]  1.00    4430.    3747.</span></span>
<span><span class="co">#&gt; 10 n_smooth      n_smooth[21,23]  1.00    5757.    3643.</span></span>
<span><span class="co">#&gt; # ℹ 1,415 more rows</span></span></code></pre></div>
<p>Here we’ve sorted the convergence diagnostics by rhat values (highest
values at the top to highlight any problems). Cut-offs for rhat
statistics are somewhat arbitrary and recommendations vary in the
literature, but values of rhat &gt; 1.1 indicate a <em>serious</em>
problem with the convergence of some of the parameters in the model
(i.e., there is more variation among the independent chains than within
them) and values of ess_bulk &lt; ~400 suggest an imprecise estimate of
the parameter. In some cases, refitting the model with more iterations
(both warmup and sampling) may improve convergence. More advice on
exploring Bayesian model convergence can be found in <a href="https://doi.org/10.1111/rssa.12378" class="external-link">Gabry et al., 2019</a>.
bbsBayes2 relies on functions in the packages <code>cmdstanr</code> and
<code>posterior</code> to calculate rhat values following <a href="https://doi.org/10.1214/20-BA1221" class="external-link">Vehtari et al. 2021</a>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>               iter_warmup <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>               iter_sampling <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span></code></pre></div>
<p>It is possible to thin the MCMC chains by passing arguments from
<code><a href="https://mc-stan.org/cmdstanr/reference/model-method-sample.html" class="external-link">cmdstanr::sample()</a></code> into the <code><a href="../reference/run_model.html">run_model()</a></code>
function. The call below would result in the same number of posterior
samples as <code><a href="../reference/run_model.html">run_model()</a></code> defaults, but may improve the
efficiency of the sampling (and of course would also increase the time
required to fit the model by a factor of approximately 4).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">mod</span>,</span>
<span>               iter_warmup <span class="op">=</span> <span class="fl">4000</span>,</span>
<span>               iter_sampling <span class="op">=</span> <span class="fl">4000</span>,</span>
<span>               thin <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>If you want summary statistics of the parameters, as well as
convergence diagnostics, the function <code><a href="../reference/get_summary.html">get_summary()</a></code> may be
more useful.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summary statistics and convergence diagnostics for all parameters</span></span>
<span><span class="va">summary_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_summary.html">get_summary</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summary statistics and convergence diagnostics for all smoothed annual indices</span></span>
<span><span class="va">summary_stats_n_smooth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_summary.html">get_summary</a></span><span class="op">(</span><span class="va">m</span>, variables <span class="op">=</span> <span class="st">"n_smooth"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">rhat</span><span class="op">)</span></span>
<span><span class="va">summary_stats_n_smooth</span></span>
<span><span class="co">#&gt; # A tibble: 1,425 × 10</span></span>
<span><span class="co">#&gt;    variable      mean median    sd   mad    q5   q95  rhat ess_bulk</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 n_smooth[21… 33.6   33.6  1.33  1.32  31.5  35.8   1.00    5881.</span></span>
<span><span class="co">#&gt;  2 n_smooth[20… 13.8   13.8  0.998 1.01  12.2  15.5   1.00    4369.</span></span>
<span><span class="co">#&gt;  3 n_smooth[20… 12.8   12.7  0.926 0.935 11.3  14.3   1.00    4363.</span></span>
<span><span class="co">#&gt;  4 n_smooth[18…  8.93   8.89 0.743 0.720  7.80 10.2   1.00    4850.</span></span>
<span><span class="co">#&gt;  5 n_smooth[24… 36.4   36.3  2.26  2.21  32.7  40.2   1.00    5138.</span></span>
<span><span class="co">#&gt;  6 n_smooth[18…  8.70   8.66 0.690 0.668  7.62  9.91  1.00    4999.</span></span>
<span><span class="co">#&gt;  7 n_smooth[16… 19.1   19.0  1.60  1.59  16.6  21.9   1.00    4498.</span></span>
<span><span class="co">#&gt;  8 n_smooth[18…  8.78   8.74 0.714 0.696  7.68 10.0   1.00    5024.</span></span>
<span><span class="co">#&gt;  9 n_smooth[16… 20.6   20.5  1.67  1.65  18.0  23.6   1.00    4430.</span></span>
<span><span class="co">#&gt; 10 n_smooth[21… 34.5   34.5  1.40  1.36  32.3  36.9   1.00    5757.</span></span>
<span><span class="co">#&gt; # ℹ 1,415 more rows</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="indices---predictions-of-annual-relative-abundance">Indices - predictions of annual relative abundance<a class="anchor" aria-label="anchor" href="#indices---predictions-of-annual-relative-abundance"></a>
</h4>
<p>Indices (annual indices of relative abundance) represent mean
predicted annual counts of the species in a given region, on an average
route, by an average observer. The pattern in the time-series of these
annual indices for a given region represent the estimated population
trajectory. We generate indices according to different categories of
regional summaries. All of the bbsBayes2 models are stratified based on
geographic spatial units, and these categories of regions are either
these strata (<code>generate_indices(region = "stratum")</code>), or
some combination of strata. By default the selected regions for most
model summaries are <code>continent</code> and <code>stratum</code>. The
<code>continent</code> estimates represent the area- and
abundance-weighted means across all strata, other regional summaries are
built in for some stratifications that allow it (e.g.,
<code>region = "country"</code> for the stratifications
<code>bbs_usgs</code>, <code>bbs_cws</code>, or
<code>prov_state</code>).</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span>model_output <span class="op">=</span> <span class="va">m</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing region continent</span></span>
<span><span class="co">#&gt; Processing region stratum</span></span></code></pre></div>
<p>We can explore or extract these indices for saving as an external
file (e.g., export to .csv), by accessing the <code>indices</code> item
in the list.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span><span class="op">[[</span><span class="st">"indices"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 1,482 × 17</span></span>
<span><span class="co">#&gt;     year region   region_type strata_included strata_excluded index</span></span>
<span><span class="co">#&gt;    &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;       &lt;chr&gt;           &lt;chr&gt;           &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1  1967 contine… continent   US-AR-24 ; US-… ""              13.1 </span></span>
<span><span class="co">#&gt;  2  1968 contine… continent   US-AR-24 ; US-… ""              12.9 </span></span>
<span><span class="co">#&gt;  3  1969 contine… continent   US-AR-24 ; US-… ""              12.9 </span></span>
<span><span class="co">#&gt;  4  1970 contine… continent   US-AR-24 ; US-… ""              12.9 </span></span>
<span><span class="co">#&gt;  5  1971 contine… continent   US-AR-24 ; US-… ""              12.9 </span></span>
<span><span class="co">#&gt;  6  1972 contine… continent   US-AR-24 ; US-… ""              12.8 </span></span>
<span><span class="co">#&gt;  7  1973 contine… continent   US-AR-24 ; US-… ""              11.7 </span></span>
<span><span class="co">#&gt;  8  1974 contine… continent   US-AR-24 ; US-… ""              11.0 </span></span>
<span><span class="co">#&gt;  9  1975 contine… continent   US-AR-24 ; US-… ""              10.3 </span></span>
<span><span class="co">#&gt; 10  1976 contine… continent   US-AR-24 ; US-… ""               9.35</span></span>
<span><span class="co">#&gt; # ℹ 1,472 more rows</span></span>
<span><span class="co">#&gt; # ℹ 11 more variables: index_q_0.025 &lt;dbl&gt;, index_q_0.05 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   index_q_0.25 &lt;dbl&gt;, index_q_0.75 &lt;dbl&gt;, index_q_0.95 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   index_q_0.975 &lt;dbl&gt;, obs_mean &lt;dbl&gt;, n_routes &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   n_routes_total &lt;int&gt;, n_non_zero &lt;int&gt;, backcast_flag &lt;dbl&gt;</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="trajectory-plots">Trajectory plots<a class="anchor" aria-label="anchor" href="#trajectory-plots"></a>
</h4>
<p>We can also generate time-series plots of these indices to visualize
population trajectories.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generates a list of ggplot graphs, one for each region</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">i</span>,</span>
<span>                  add_observed_means <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># optional argument to show raw observed mean counts</span></span></code></pre></div>
<p>Note that we get one plot for each region and regional category, in
this case that means one plot for the continent, and one for each
stratum.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "continent" "US_AR_24"  "US_AR_25"  "US_AR_26"  "US_KS_18" </span></span>
<span><span class="co">#&gt;  [6] "US_KS_19"  "US_KS_22"  "US_LA_25"  "US_LA_37"  "US_MO_22" </span></span>
<span><span class="co">#&gt; [11] "US_MO_24"  "US_NM_18"  "US_NM_35"  "US_OK_18"  "US_OK_19" </span></span>
<span><span class="co">#&gt; [16] "US_OK_21"  "US_OK_22"  "US_OK_25"  "US_TX_18"  "US_TX_19" </span></span>
<span><span class="co">#&gt; [21] "US_TX_20"  "US_TX_21"  "US_TX_25"  "US_TX_35"  "US_TX_36" </span></span>
<span><span class="co">#&gt; [26] "US_TX_37"</span></span></code></pre></div>
<p>We can plot them individually by pulling a plot out of the list</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">[[</span><span class="st">"continent"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-36-1.png" alt="Population trajectory graph, showing the estimated annual relative abundances, their associated 95% credible intervals, and points representing the raw mean observed counts."></p>
<p>Each of these plots is a <a href="https://github.com/tidyverse/ggplot2" class="external-link">ggplot2</a> object that can
be modified like any other. For example, you can modify titles or
axes.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1_mod</span> <span class="op">&lt;-</span> <span class="va">p</span><span class="op">[[</span><span class="st">"continent"</span><span class="op">]</span><span class="op">]</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>,<span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> <span class="co">#subset of years</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span> <span class="co"># remove the title</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p1_mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-37-1.png" alt="Population trajectory graph, modified to show only the last 20 years of the time-series and remove the title"></p>
<div class="section level5">
<h5 id="spaghetti-plots-to-show-uncertainty-in-population-trajectories">Spaghetti plots to show uncertainty in population trajectories<a class="anchor" aria-label="anchor" href="#spaghetti-plots-to-show-uncertainty-in-population-trajectories"></a>
</h5>
<p>The most common inference to draw from one of these BBS models
relates to the estimates of the population trajectory. One particularly
useful way to visualise the uncertainty of those population trajectories
is to plot many posterior draws of the full trajectory. The default
population trajectories plots <code><a href="../reference/plot_indices.html">plot_indices()</a></code> show a line
representing the path of the annual posterior medians of the annual
indices and an uncertainty band spanning the outer limits of a credible
interval on the annual indices. These are reasonable summaries of the
uncertainty in the collection of annual indices. However, the
uncertainty of each annual index of abundance includes information about
the uncertainty in the estimate of the change in abundance through time
(e.g., trend) and uncertainty in the estimate of the mean abundance
(e.g., the mean count in any given route or observer). Those two sources
of uncertainty can be correlated in the posterior distribution, so that
the uncertainty of the annual indices may over-estimate the uncertainty
in the trend. To plot a sample of estimated trajectories, set the
<code>spaghetti = TRUE</code> argument in the
<code><a href="../reference/plot_indices.html">plot_indices()</a></code> function.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># generates a list of ggplot graphs, one for each region</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="va">i</span>,</span>
<span>                  add_observed_means <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">[[</span><span class="st">"continent"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="articles/articles/figures/bbsBayes2_unnamed-chunk-38-1.png" alt="plot of chunk unnamed-chunk-38"> There are arguments that also
allow the user to control the transparency of each plotted line, as well
as the number of lines to plot (the default is to draw 100 random
samples).</p>
</div>
</div>
<div class="section level4">
<h4 id="trends---predictions-of-mean-rates-of-change-over-time">Trends - predictions of mean rates of change over time<a class="anchor" aria-label="anchor" href="#trends---predictions-of-mean-rates-of-change-over-time"></a>
</h4>
<p>Next we can calculate the long-term trends based on these indices.
Note all trends from bbsBayes2 models are derived from summaries of
indices through time or between two points in time.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span></code></pre></div>
<p>We can explore or extract these trends for saving as an external file
(e.g., export to .csv), by accessing the <code>trends</code> item in the
list.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t</span><span class="op">[[</span><span class="st">"trends"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 26 × 27</span></span>
<span><span class="co">#&gt;    start_year end_year region    region_type strata_included       </span></span>
<span><span class="co">#&gt;         &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;chr&gt;                 </span></span>
<span><span class="co">#&gt;  1       1967     2023 continent continent   US-AR-24 ; US-AR-25 ;…</span></span>
<span><span class="co">#&gt;  2       1967     2023 US-AR-24  stratum     US-AR-24              </span></span>
<span><span class="co">#&gt;  3       1967     2023 US-AR-25  stratum     US-AR-25              </span></span>
<span><span class="co">#&gt;  4       1967     2023 US-AR-26  stratum     US-AR-26              </span></span>
<span><span class="co">#&gt;  5       1967     2023 US-KS-18  stratum     US-KS-18              </span></span>
<span><span class="co">#&gt;  6       1967     2023 US-KS-19  stratum     US-KS-19              </span></span>
<span><span class="co">#&gt;  7       1967     2023 US-KS-22  stratum     US-KS-22              </span></span>
<span><span class="co">#&gt;  8       1967     2023 US-LA-25  stratum     US-LA-25              </span></span>
<span><span class="co">#&gt;  9       1967     2023 US-LA-37  stratum     US-LA-37              </span></span>
<span><span class="co">#&gt; 10       1967     2023 US-MO-22  stratum     US-MO-22              </span></span>
<span><span class="co">#&gt; # ℹ 16 more rows</span></span>
<span><span class="co">#&gt; # ℹ 22 more variables: strata_excluded &lt;chr&gt;, trend &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   trend_q_0.025 &lt;dbl&gt;, trend_q_0.05 &lt;dbl&gt;, trend_q_0.25 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   trend_q_0.75 &lt;dbl&gt;, trend_q_0.95 &lt;dbl&gt;, trend_q_0.975 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   percent_change &lt;dbl&gt;, percent_change_q_0.025 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   percent_change_q_0.05 &lt;dbl&gt;, percent_change_q_0.25 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   percent_change_q_0.75 &lt;dbl&gt;, percent_change_q_0.95 &lt;dbl&gt;, …</span></span></code></pre></div>
<p>We can generate trends for different periods of time, using any
combination of a starting year <code>min_year</code> and ending year
<code>max_year</code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_10</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span><span class="va">i</span>,</span>
<span>                        min_year <span class="op">=</span> <span class="fl">2011</span>,</span>
<span>                        max_year <span class="op">=</span> <span class="fl">2021</span><span class="op">)</span></span>
<span><span class="va">t_10</span></span>
<span><span class="co">#&gt; $trends</span></span>
<span><span class="co">#&gt; # A tibble: 26 × 27</span></span>
<span><span class="co">#&gt;    start_year end_year region    region_type strata_included       </span></span>
<span><span class="co">#&gt;         &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;chr&gt;                 </span></span>
<span><span class="co">#&gt;  1       2011     2021 continent continent   US-AR-24 ; US-AR-25 ;…</span></span>
<span><span class="co">#&gt;  2       2011     2021 US-AR-24  stratum     US-AR-24              </span></span>
<span><span class="co">#&gt;  3       2011     2021 US-AR-25  stratum     US-AR-25              </span></span>
<span><span class="co">#&gt;  4       2011     2021 US-AR-26  stratum     US-AR-26              </span></span>
<span><span class="co">#&gt;  5       2011     2021 US-KS-18  stratum     US-KS-18              </span></span>
<span><span class="co">#&gt;  6       2011     2021 US-KS-19  stratum     US-KS-19              </span></span>
<span><span class="co">#&gt;  7       2011     2021 US-KS-22  stratum     US-KS-22              </span></span>
<span><span class="co">#&gt;  8       2011     2021 US-LA-25  stratum     US-LA-25              </span></span>
<span><span class="co">#&gt;  9       2011     2021 US-LA-37  stratum     US-LA-37              </span></span>
<span><span class="co">#&gt; 10       2011     2021 US-MO-22  stratum     US-MO-22              </span></span>
<span><span class="co">#&gt; # ℹ 16 more rows</span></span>
<span><span class="co">#&gt; # ℹ 22 more variables: strata_excluded &lt;chr&gt;, trend &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   trend_q_0.025 &lt;dbl&gt;, trend_q_0.05 &lt;dbl&gt;, trend_q_0.25 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   trend_q_0.75 &lt;dbl&gt;, trend_q_0.95 &lt;dbl&gt;, trend_q_0.975 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   percent_change &lt;dbl&gt;, percent_change_q_0.025 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   percent_change_q_0.05 &lt;dbl&gt;, percent_change_q_0.25 &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   percent_change_q_0.75 &lt;dbl&gt;, percent_change_q_0.95 &lt;dbl&gt;, …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data</span></span>
<span><span class="co">#&gt; $meta_data$stratify_by</span></span>
<span><span class="co">#&gt; [1] "bbs_usgs"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$stratify_type</span></span>
<span><span class="co">#&gt; [1] "standard"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$species</span></span>
<span><span class="co">#&gt; [1] "Scissor-tailed Flycatcher"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$model</span></span>
<span><span class="co">#&gt; [1] "gamye"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$model_variant</span></span>
<span><span class="co">#&gt; [1] "spatial"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$model_file</span></span>
<span><span class="co">#&gt; [1] "C:/Users/SmithAC/AppData/Local/Programs/R/R-4.4.1/library/bbsBayes2/models/gamye_spatial_bbs_CV.stan"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$run_date</span></span>
<span><span class="co">#&gt; [1] "2024-09-28 18:05:30 EDT"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$bbsBayes2_version</span></span>
<span><span class="co">#&gt; [1] "1.1.2"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$cmdstan_path</span></span>
<span><span class="co">#&gt; [1] "//wsl$/Ubuntu/home/smithac/.cmdstan/cmdstan-2.35.0"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$cmdstan_version</span></span>
<span><span class="co">#&gt; [1] "2.35.0"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$regions</span></span>
<span><span class="co">#&gt; [1] "continent" "stratum"  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$start_year</span></span>
<span><span class="co">#&gt; [1] 1967</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$n_years</span></span>
<span><span class="co">#&gt; [1] 57</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$hpdi_indices</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$hpdi_trends</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_data$gam_smooth_trends</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $meta_strata</span></span>
<span><span class="co">#&gt; # A tibble: 25 × 5</span></span>
<span><span class="co">#&gt;    strata_name strata area_sq_km continent stratum </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;        &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;   </span></span>
<span><span class="co">#&gt;  1 US-AR-24         1     33232. continent US-AR-24</span></span>
<span><span class="co">#&gt;  2 US-AR-25         2     65340. continent US-AR-25</span></span>
<span><span class="co">#&gt;  3 US-AR-26         3     39366. continent US-AR-26</span></span>
<span><span class="co">#&gt;  4 US-KS-18         4     37179. continent US-KS-18</span></span>
<span><span class="co">#&gt;  5 US-KS-19         5    109390. continent US-KS-19</span></span>
<span><span class="co">#&gt;  6 US-KS-22         6     66243. continent US-KS-22</span></span>
<span><span class="co">#&gt;  7 US-LA-25         7     47075. continent US-LA-25</span></span>
<span><span class="co">#&gt;  8 US-LA-37         8     24987. continent US-LA-37</span></span>
<span><span class="co">#&gt;  9 US-MO-22         9     83079. continent US-MO-22</span></span>
<span><span class="co">#&gt; 10 US-MO-24        10     87034. continent US-MO-24</span></span>
<span><span class="co">#&gt; # ℹ 15 more rows</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $raw_data</span></span>
<span><span class="co">#&gt; # A tibble: 13,250 × 23</span></span>
<span><span class="co">#&gt;    country_num state_num state   rpid   bcr  year strata_name route</span></span>
<span><span class="co">#&gt;          &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1         840         7 ARKAN…   101    24  1967 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  2         840         7 ARKAN…   101    24  1968 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  3         840         7 ARKAN…   101    24  1969 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  4         840         7 ARKAN…   101    24  1970 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  5         840         7 ARKAN…   101    24  1971 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  6         840         7 ARKAN…   101    24  1972 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  7         840         7 ARKAN…   101    24  1973 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  8         840         7 ARKAN…   101    24  1974 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt;  9         840         7 ARKAN…   101    24  1975 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt; 10         840         7 ARKAN…   101    24  1976 US-AR-24    7-20 </span></span>
<span><span class="co">#&gt; # ℹ 13,240 more rows</span></span>
<span><span class="co">#&gt; # ℹ 15 more variables: obs_n &lt;dbl&gt;, count &lt;dbl&gt;, n_routes &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   non_zero_weight &lt;dbl&gt;, first_year &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   max_n_routes_year &lt;int&gt;, n_obs &lt;int&gt;, mean_obs &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   year_num &lt;dbl&gt;, strata &lt;dbl&gt;, observer &lt;int&gt;, site &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   obs_route &lt;chr&gt;, obs_site &lt;int&gt;, n_obs_sites &lt;int&gt;</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="trend-maps---visualizing-the-spatial-variation-in-trends">Trend maps - visualizing the spatial variation in trends<a class="anchor" aria-label="anchor" href="#trend-maps---visualizing-the-spatial-variation-in-trends"></a>
</h4>
<p>We can plot trend estimates on a map to visualise the spatial
patterns in population change.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trend_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">trend_map</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-42-1.png" alt="Population trend map showing strata with increasing trends in blues and decreasing trends in reds."></p>
<p>The maps are also <a href="https://github.com/tidyverse/ggplot2" class="external-link">ggplot2</a> objects that can
be modified like any other. For example, you can zoom into a section of
the map.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get the meta data in trend object - strata information</span></span>
<span><span class="va">strata_with_data</span> <span class="op">&lt;-</span> <span class="va">t</span><span class="op">$</span><span class="va">meta_strata</span></span>
<span></span>
<span><span class="co"># Load the original strata map used in the model fitting</span></span>
<span><span class="co"># then filter to just the strata with data for this species</span></span>
<span><span class="va">data_bounding_box</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_map.html">load_map</a></span><span class="op">(</span>stratify_by <span class="op">=</span> <span class="va">t</span><span class="op">$</span><span class="va">meta_data</span><span class="op">$</span><span class="va">stratify_by</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">strata_name</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">strata_with_data</span><span class="op">$</span><span class="va">strata_name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># create a bounding box for x and y limits</span></span>
<span></span>
<span><span class="va">t_mod</span> <span class="op">&lt;-</span> <span class="va">trend_map</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="va">data_bounding_box</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"xmin"</span>,<span class="st">"xmax"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>           ylim <span class="op">=</span> <span class="va">data_bounding_box</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ymin"</span>,<span class="st">"ymax"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate system already present. Adding new coordinate system,</span></span>
<span><span class="co">#&gt; which will replace the existing one.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">t_mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-43-1.png" alt="Population trend map zoomed in to show just the relevant regions"></p>
</div>
<div class="section level4">
<h4 id="barn-swallow-example">Barn Swallow example<a class="anchor" aria-label="anchor" href="#barn-swallow-example"></a>
</h4>
<p>A model with a suitable number of iterations takes a long time to run
(the Barn Swallow model, a species with many counts, years and strata,
took 54 hours).</p>
<p>You can download an example of the saved model output for Barn
Swallow here:</p>
<p><a href="https://drive.google.com/file/d/1jFzzoJel6B2bg6yOmhMHnGTxkLaTRaRn/view?usp=sharing" class="external-link">An
example of the output from applying the spatial gamye model to Barn
Swallow data</a>.</p>
<p>In this example we’ve placed it in a sub-directory of our working
directory called <em>output</em>.</p>
<p>Let’s take a look at the spatial GAMYE model for the Barn
Swallow.</p>
<p>First we load the data</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BARS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"output/Barn_Swallow_gamye_spatial.rds"</span><span class="op">)</span></span></code></pre></div>
<p>We can investigate the model meta data</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BARS</span><span class="op">$</span><span class="va">meta_data</span></span>
<span><span class="co">#&gt; $stratify_by</span></span>
<span><span class="co">#&gt; [1] "bbs_cws"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $stratify_type</span></span>
<span><span class="co">#&gt; [1] "standard"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $species</span></span>
<span><span class="co">#&gt; [1] "Barn Swallow"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $model</span></span>
<span><span class="co">#&gt; [1] "gamye"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $model_variant</span></span>
<span><span class="co">#&gt; [1] "spatial"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $model_file</span></span>
<span><span class="co">#&gt; [1] "C:/Users/SmithAC/AppData/Local/R/win-library/4.2/bbsBayes2/models/gamye_spatial_bbs_CV.stan"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $run_date</span></span>
<span><span class="co">#&gt; [1] "2023-01-20 13:27:49 EST"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $bbsBayes2_version</span></span>
<span><span class="co">#&gt; [1] "1.0.0"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $cmdstan_path</span></span>
<span><span class="co">#&gt; [1] "C:/Users/SmithAC/Documents/.cmdstan/wsl-cmdstan-2.30.1"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $cmdstan_version</span></span>
<span><span class="co">#&gt; [1] "2.30.1"</span></span></code></pre></div>
<p>See the length of the run in seconds or hours</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BARS</span><span class="op">$</span><span class="va">model_fit</span><span class="op">$</span><span class="fu">time</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $total</span></span>
<span><span class="co">#&gt; [1] 197011.7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $chains</span></span>
<span><span class="co">#&gt;   chain_id   warmup sampling  total</span></span>
<span><span class="co">#&gt; 1        1  82393.1  46100.9 128494</span></span>
<span><span class="co">#&gt; 2        2  85907.6 111101.0 197009</span></span>
<span><span class="co">#&gt; 3        3 113442.0  54516.1 167958</span></span>
<span><span class="co">#&gt; 4        4 113073.0  54597.2 167670</span></span>
<span><span class="va">BARS</span><span class="op">$</span><span class="va">model_fit</span><span class="op">$</span><span class="fu">time</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">total</span><span class="op">/</span><span class="fl">3600</span></span>
<span><span class="co">#&gt; [1] 54.72546</span></span></code></pre></div>
<p>Now create the indices and trends</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">BARS_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">BARS</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing region continent</span></span>
<span><span class="co">#&gt; Processing region stratum</span></span>
<span></span>
<span><span class="va">BARS_index_plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_indices.html">plot_indices</a></span><span class="op">(</span><span class="va">BARS_indices</span>,</span>
<span>                                 add_observed_means <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                 add_number_routes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">BARS_continent</span> <span class="op">&lt;-</span> <span class="va">BARS_index_plots</span><span class="op">[[</span><span class="st">"continent"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">BARS_continent</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-47-1.png" alt="Population trajectory graph for Barn Swallow, showing the estimated annual relative abundances, their associated 95% credible intervals, and points representing the raw mean observed counts."></p>
</div>
<div class="section level4">
<h4 id="smoothed-population-trajectories---gamye-model">Smoothed population trajectories - gamye model<a class="anchor" aria-label="anchor" href="#smoothed-population-trajectories---gamye-model"></a>
</h4>
<p>Above, we’ve plotted the full annual indices (i.e., the population
trajectory) from the gamye model. In the <em>gamye</em> and
<em>slope</em> models, the population trajectory can be decomposed into
two components: the smooth component and the annual fluctuations around
the smooth. The default estimate of the population trajectory uses the
<em>full</em> version of the annual indices
(<code>generate_indices(alternate_n = "n")</code>). For the gamye model
the alternate population trajectory that represents only the
semi-parametric smooth component can be accessed by choosing the
<code>generate_indices(alternate_n = "n_smooth")</code> option. For the
slope model the alternate population trajectory that represents the
linear smooth only can be accessed by choosing the
<code>generate_indices(alternate_n = "n_slope")</code> option. These
smooth trajectories may be useful for trend estimates that vary less
from year-to-year (gamye model) or for an overall linear trend from a
slope model applied to a short time-frame (it’s probably unlikely that a
linear smooth is reasonable for long periods of time).</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BARS_smooth_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_indices.html">generate_indices</a></span><span class="op">(</span><span class="va">BARS</span>,</span>
<span>                                        alternate_n <span class="op">=</span> <span class="st">"n_smooth"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Processing region continent</span></span>
<span><span class="co">#&gt; Processing region stratum</span></span>
<span><span class="va">BARS_trends</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_trends.html">generate_trends</a></span><span class="op">(</span><span class="va">BARS_smooth_indices</span><span class="op">)</span></span>
<span><span class="va">BARS_trend_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">BARS_trends</span><span class="op">)</span></span>
<span><span class="va">BARS_trend_map</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-48-1.png" alt="Population trend map for Barn Swallow, showing strata with increasing trends in shades of blue and strata with decreasing trends in shades of red">
### Modifying base plots</p>
<p>We can also add the smoothed annual indices to the plots of the full
annual indices from above, taking advantage of the <a href="https://github.com/tidyverse/ggplot2" class="external-link">ggplot2</a> functions such
as <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line()</a></code>.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">smooth_cont_indices</span> <span class="op">&lt;-</span> <span class="va">BARS_smooth_indices</span><span class="op">$</span><span class="va">indices</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"continent"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">BARS_continent_both</span> <span class="op">&lt;-</span> <span class="va">BARS_continent</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">smooth_cont_indices</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">year</span>, y <span class="op">=</span> <span class="va">index</span><span class="op">)</span>,</span>
<span>            alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>            linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"grey line represents the smoothed annual indices"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">BARS_continent_both</span><span class="op">)</span></span></code></pre></div>
<p><img src="figures%2FbbsBayes2_unnamed-chunk-49-1.png" alt="Population trajectory graph for Barn Swallow, same as above plus the smoothed annual indices are added as a grey line"></p>
<p>Check out the other articles to explore more advanced usage or the <a href="../reference/">function reference</a> to see what functions are
available and how to use them in greater detail.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Brandon P.M. Edwards, Adam C. Smith, Steffi LaZerte.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
